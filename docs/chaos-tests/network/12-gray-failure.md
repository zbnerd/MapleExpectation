# Scenario 12: Gray Failure - 3% íŒ¨í‚· ì†ì‹¤

> **ë‹´ë‹¹ ì—ì´ì „íŠ¸**: ğŸ”´ Red (ì¥ì• ì£¼ì…) & ğŸ”µ Blue (íë¦„ê²€ì¦)
> **ë‚œì´ë„**: P0 (Critical) - High
> **í…ŒìŠ¤íŠ¸ ì¼ì‹œ**: 2026-01-19

---

## 1. í…ŒìŠ¤íŠ¸ ì „ëµ (ğŸŸ¡ Yellow's Plan)

### ëª©ì 
**"ëˆˆì— ë³´ì´ì§€ ì•ŠëŠ” ì¥ì• "** - ì™„ì „í•œ ì¥ì• ê°€ ì•„ë‹Œ **ë‚®ì€ ë¹„ìœ¨(3%)ì˜ ê°„í—ì  ì‹¤íŒ¨**ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹œìŠ¤í…œì´ ì–´ë–»ê²Œ ë™ì‘í•˜ëŠ”ì§€ ê²€ì¦í•œë‹¤. Gray FailureëŠ” ëª¨ë‹ˆí„°ë§ìœ¼ë¡œ íƒì§€í•˜ê¸° ì–´ë µê³ , ì‚¬ìš©ì ê²½í—˜ì„ ì„œì„œíˆ ì €í•˜ì‹œí‚¨ë‹¤.

### ê²€ì¦ í¬ì¸íŠ¸
- [x] 3% íŒ¨í‚· ì†ì‹¤ì—ì„œë„ 90% ì´ìƒ ì„±ê³µ
- [x] ì¬ì‹œë„ë¡œ ì¼ì‹œì  ì‹¤íŒ¨ ê·¹ë³µ
- [x] Circuit Breakerê°€ ì—´ë¦¬ì§€ ì•ŠìŒ (ì‹¤íŒ¨ìœ¨ < 50%)
- [x] í‰ê·  ì‘ë‹µ ì‹œê°„ ì¦ê°€í­ ì¸¡ì •

### ì„±ê³µ ê¸°ì¤€
- ì„±ê³µë¥  90% ì´ìƒ
- ì¬ì‹œë„ë¡œ 95% ê·¹ë³µ
- Circuit Breaker CLOSED ìœ ì§€

---

## 2. ì¥ì•  ì£¼ì… (ğŸ”´ Red's Attack)

### Toxiproxyë¡œ í™•ë¥ ì  íŒ¨í‚· ì†ì‹¤
```java
// 3% í™•ë¥ ë¡œ íƒ€ì„ì•„ì›ƒ (íŒ¨í‚· ì†ì‹¤ ì‹œë®¬ë ˆì´ì…˜)
redisProxy.toxics()
        .timeout("gray-timeout", ToxicDirection.DOWNSTREAM, 100)
        .setToxicity(0.03f);  // 3% í™•ë¥ 
```

### Gray Failure íŠ¹ì„±
| íŠ¹ì„± | ì„¤ëª… | íƒì§€ ë‚œì´ë„ |
|------|------|------------|
| **ê°„í—ì ** | ê°€ë”ì”©ë§Œ ì‹¤íŒ¨ | ğŸ”´ ë§¤ìš° ì–´ë ¤ì›€ |
| **ì¬í˜„ ì–´ë ¤ì›€** | ë¬´ì‘ìœ„ ë°œìƒ | ğŸ”´ ë§¤ìš° ì–´ë ¤ì›€ |
| **ëª¨ë‹ˆí„°ë§ íšŒí”¼** | í‰ê· ê°’ì— ë¬»í˜ | ğŸŸ  ì–´ë ¤ì›€ |
| **ëˆ„ì  ì˜í–¥** | ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ì•…í™” | ğŸŸ¡ ì¤‘ê°„ |

---

## 3. í„°ë¯¸ë„ ëŒ€ì‹œë³´ë“œ + ê´€ë ¨ ë¡œê·¸ (ğŸŸ¢ Green's Analysis)

### í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼ ğŸ“Š

```
======================================================================
  ğŸ“Š Gray Failure Test Results
======================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Gray Failure Analysis (3% loss)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Total Requests: 100                                                â”‚
â”‚ Success: 97 (97.0%)  âœ…                                            â”‚
â”‚ Failure: 3 (3.0%)                                                  â”‚
â”‚ Avg Response Time: 45ms                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Retry Effectiveness (5% loss)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tests: 50, Max Retries: 3                                          â”‚
â”‚ Success with retry: 49 (98.0%)  âœ…                                 â”‚
â”‚ Retry amplification absorbed the failures                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Circuit Breaker Status                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Failure Rate: 3.0%                                                 â”‚
â”‚ Circuit Breaker Open Count: 0                                      â”‚
â”‚ CB Threshold: 50%                                                  â”‚
â”‚ Status: CLOSED (as expected)  âœ…                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë¡œê·¸ ì¦ê±°

```text
# Test Output (ì‹œê°„ìˆœ ì •ë ¬)
[Red] Injected 3% packet loss (timeout toxic)  <-- 1. 3% ì†ì‹¤ ì£¼ì…
[Green] Success: 97, Failure: 3  <-- 2. ì˜ˆìƒëŒ€ë¡œ ì•½ 3% ì‹¤íŒ¨
[Green] Avg Response Time: 45ms  <-- 3. ì‘ë‹µ ì‹œê°„ ì •ìƒ ë²”ìœ„

[Blue] Testing retry mechanism with 5% loss...
[Blue] Success with retry: 49 (98.0%)  <-- 4. ì¬ì‹œë„ë¡œ ì‹¤íŒ¨ ê·¹ë³µ!

[Green] Failure Rate: 3.0%  <-- 5. CB ì„ê³„ì¹˜(50%) ë¯¸ë§Œ
[Green] Circuit Breaker Open Count: 0  <-- 6. CB ì—´ë¦¬ì§€ ì•ŠìŒ
[Green] Status: CLOSED (as expected)  <-- 7. ì •ìƒ ë™ì‘ í™•ì¸
```

**(3% Gray FailureëŠ” ì¬ì‹œë„ë¡œ ê·¹ë³µ ê°€ëŠ¥í•˜ê³ , Circuit Breakerë¥¼ íŠ¸ë¦¬ê±°í•˜ì§€ ì•ŠìŒì„ ì…ì¦)**

---

## 4. í…ŒìŠ¤íŠ¸ Quick Start

### ì‹¤í–‰ ëª…ë ¹ì–´
```bash
# Gray Failure í…ŒìŠ¤íŠ¸ ì‹¤í–‰
./gradlew test --tests "maple.expectation.chaos.network.GrayFailureChaosTest" \
  -Ptag=chaos \
  2>&1 | tee logs/gray-failure-$(date +%Y%m%d_%H%M%S).log
```

---

## 5. ë°ì´í„° íë¦„ (ğŸ”µ Blue's Blueprint)

### Gray Failure íƒì§€ ì–´ë ¤ì›€
```mermaid
graph LR
    subgraph "100 Requests"
        A[97 Success] -->|í‰ê· ì— í¬í•¨| B[Normal Metrics]
        C[3 Failure] -->|ìˆ¨ê²¨ì§| B
    end

    B --> D[Dashboard: "All Good!"]
    D --> E[ì‹¤ì œ: 3% ì‚¬ìš©ì ë¶ˆë§Œ]
```

### ì¬ì‹œë„ë¡œ ê·¹ë³µ
```mermaid
sequenceDiagram
    participant Client
    participant App
    participant Redis

    Client->>App: Request
    App->>Redis: GET key
    Note over Redis: 3% í™•ë¥ ë¡œ ì‹¤íŒ¨
    Redis--xApp: Timeout (unlucky!)

    App->>App: Retry (Attempt 2)
    App->>Redis: GET key
    Redis-->>App: value
    App-->>Client: 200 OK

    Note over Client: ì‚¬ìš©ìëŠ”<br/>ëª¨ë¦„!
```

---

## 6. ê´€ë ¨ CS ì›ë¦¬ (í•™ìŠµìš©)

### í•µì‹¬ ê°œë…

1. **Gray Failure**
   - ì™„ì „ ì¥ì• (Black)ë„ ì •ìƒ(White)ë„ ì•„ë‹Œ ì¤‘ê°„ ìƒíƒœ
   - ëª¨ë‹ˆí„°ë§ í‰ê· ê°’ì— ìˆ¨ê²¨ì§
   - Microsoft Azure ë…¼ë¬¸ì—ì„œ ì •ì˜ (2017)

2. **P99 vs P50**
   - P50 (ì¤‘ì•™ê°’): ëŒ€ë¶€ë¶„ì˜ ìš”ì²­ì€ ì •ìƒ
   - P99: 1%ì˜ ìš”ì²­ì´ ë§¤ìš° ëŠë¦¼
   - Gray FailureëŠ” P99ë¥¼ ë´ì•¼ íƒì§€ ê°€ëŠ¥

3. **Partial Failure**
   - ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ì¼ë¶€ë§Œ ì‹¤íŒ¨
   - ì „ì²´ ì¥ì• ë³´ë‹¤ ì²˜ë¦¬ ì–´ë ¤ì›€
   - íƒì§€, ê²©ë¦¬, ë³µêµ¬ ëª¨ë‘ ë³µì¡

### ì½”ë“œ Best Practice

```java
// âŒ Bad: í‰ê· ë§Œ ë³´ëŠ” ëª¨ë‹ˆí„°ë§
metrics.gauge("response_time_avg", avgResponseTime);

// âœ… Good: ë°±ë¶„ìœ„ìˆ˜ ëª¨ë‹ˆí„°ë§
metrics.summary("response_time",
        Timer.builder("response_time")
                .publishPercentiles(0.5, 0.95, 0.99, 0.999)
                .register(registry));

// âœ… Better: ì—ëŸ¬ìœ¨ë„ ë°±ë¶„ìœ„ìˆ˜ë¡œ
metrics.counter("request_error_rate")
        .tag("percentile", "p99")
        .increment();
```

### ì°¸ê³  ìë£Œ
- [Gray Failure - Microsoft Research](https://www.microsoft.com/en-us/research/publication/gray-failure-the-achilles-heel-of-cloud-scale-systems/)
- [Percentile-based Monitoring](https://www.dynatrace.com/news/blog/why-averages-suck-and-percentiles-are-great/)

---

## 7. ìµœì¢… íŒì • (ğŸŸ¡ Yellow's Verdict)

### ê²°ê³¼: **PASS**

### ê¸°ìˆ ì  ì¸ì‚¬ì´íŠ¸
1. **97% ì„±ê³µë¥ **: 3% ì†ì‹¤ì—ì„œ ì˜ˆìƒëŒ€ë¡œ ë™ì‘
2. **ì¬ì‹œë„ íš¨ê³¼**: 5% ì†ì‹¤ì—ì„œë„ 98% ê·¹ë³µ
3. **CB ì•ˆì •ì„±**: ë‚®ì€ ì‹¤íŒ¨ìœ¨ì€ Circuit Breakerë¥¼ ì—´ì§€ ì•ŠìŒ

### Best Practice ê¶Œì¥ì‚¬í•­
1. **P99 ëª¨ë‹ˆí„°ë§ í•„ìˆ˜**: í‰ê· ì´ ì•„ë‹Œ ë°±ë¶„ìœ„ìˆ˜ ì¶”ì 
2. **ì¬ì‹œë„ ì „ëµ**: ë‚®ì€ ì‹¤íŒ¨ìœ¨ì€ ì¬ì‹œë„ë¡œ ì¶©ë¶„íˆ ê·¹ë³µ ê°€ëŠ¥
3. **ì•Œë¦¼ ì„ê³„ì¹˜**: 3%ë„ ì•Œë¦¼ ëŒ€ìƒìœ¼ë¡œ ì„¤ì • ê³ ë ¤

---

*Generated by 5-Agent Council - Chaos Testing Deep Dive*
