# N19 Outbox Replay ì¥ì•  ë³µêµ¬ ë¦¬í¬íŠ¸

**ì¸ì‹œë˜íŠ¸ ID**: N19-20260205-140000
**ë³´ê³ ì„œ ì¼ì**: 2026-02-05
**ë³´ê³ ì„œ ìœ í˜•**: ìš´ì˜ ì¦ê±° - ì‚¬í›„ ë¶„ì„
**ë¶„ë¥˜**: Critical (P0) - ìë™ ë³µêµ¬
**ì‹œê°„ëŒ€**: KST (UTC+9)

---

## Fail If Wrong (ë¦¬í¬íŠ¸ ë¬´íš¨í™” ì¡°ê±´)

ì´ ë³´ê³ ì„œëŠ” ë‹¤ìŒ ì¡°ê±´ì—ì„œ **ì¦‰ì‹œ ë¬´íš¨í™”**ë©ë‹ˆë‹¤:

1. **Reconciliation ë¶ˆë³€ì‹ ìœ„ë°˜**: `mismatch != 0`ì¸ ê²½ìš°
2. **ë³µêµ¬ ì„±ê³µë¥¨ ë¯¸ë‹¬**: ìë™ ë³µêµ¬ìœ¨ < 99.9%ì¸ ê²½ìš°
3. **DLQ ë¯¸ë¶„ë¥˜**: DLQ ì´ë™ ê±´ì´ ìˆì§€ë§Œ ë¶„ë¥˜/ì‚¬í›„ ì²˜ë¦¬ë˜ì§€ ì•Šì€ ê²½ìš°
4. **ì´ë²¤íŠ¸ ìœ ì‹¤**: ì¥ì•  ìœˆë„ìš° ì¤‘ Outboxì— ì €ì¥ë˜ì§€ ì•Šì€ ì´ë²¤íŠ¸ê°€ ë°œê²¬ëœ ê²½ìš°
5. **íƒ€ì„ë¼ì¸ ëª¨ìˆœ**: MTTD + MTTR != ì´ ì¥ì•  ì‹œê°„ì¸ ê²½ìš°

---

## 1. ê²½ì˜ì§„ ë³´ê³ ì„œ (Executive Summary)

### ì¸ì‹œë˜íŠ¸ ê°œìš”
2026-02-05, ì™¸ë¶€ API 6ì‹œê°„ ì¥ì• ë¡œ ì¸í•´ 210ë§Œ ê±´ì˜ ì´ë²¤íŠ¸ê°€ Outboxì— íì‰ë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜ì´ 47ë¶„ ë§Œì— ëª¨ë“  í ì´ë²¤íŠ¸ë¥¼ 99.98% ì„±ê³µë¥ ë¡œ ì²˜ë¦¬í•˜ì—¬ ë°ì´í„° ìœ ì‹¤ì„ ë°©ì§€í–ˆìŠµë‹ˆë‹¤ [E1, L1, L3]. ì´ë²ˆ ì¥ì• ëŠ” Transactional Outbox Patternê³¼ ìë™ ì¬ì²˜ë¦¬ ë©”ì»¤ë‹ˆì¦˜ì˜ íš¨ê³¼ì„±ì„ ê²€ì¦í–ˆìŠµë‹ˆë‹¤.

### í•µì‹¬ ì„±ê³¼
- **ì˜í–¥**: 216ë§Œ ê±´ ì´ë²¤íŠ¸ íì‰, ë°ì´í„° ìœ ì‹¤ 0ê±´ [SQL-1, SQL-4]
- **ë³µêµ¬**: 99.98% ìë™ ë³µêµ¬ (47ë¶„ ì†Œìš”) [E1, L2]
- **ì²˜ë¦¬ëŸ‰**: ì¬ì²˜ë¦¬ peak ì‹œ 1,200 TPS [G1]
- **ë¹„ìš© (ì¦ë¶„)**:
  - **Compute ì „ìš©**: **$12.50** (replay window 47ë¶„)
  - **ì´ ì¦ë¶„ ë¹„ìš©**: **$23.75** (compute + DB I/O + network) [C1]
  - ë¹„ìš© ì‚°ì • ìƒì„¸ëŠ” Appendix A ì°¸ì¡°

### ë¹„ì¦ˆë‹ˆìŠ¤ ì„íŒ©íŠ¸
| í•­ëª© | ì˜í–¥ |
|------|------|
| ì‚¬ìš©ì ì˜í–¥ | ì¼ì‹œì  ì„œë¹„ìŠ¤ ì§€ì—° (6ì‹œê°„) |
| ë°ì´í„° ìœ ì‹¤ | **0ê±´** (ì™„ì „ ë³´ì¡´) |
| ìˆ˜ë™ ë³µêµ¬ | **ë¶ˆí•„ìš”** (100% ìë™í™”) |
| ìš´ì˜ ë¶€í•˜ | ìµœì†Œí™” (ì•Œë¦¼ë§Œ ìˆ˜ì‹ ) |

---

## 2. ì¥ì•  íƒ€ì„ë¼ì¸

### Phase 1: ì¥ì•  ê°ì§€ ë° ì˜í–¥ ë¶„ì„
- **T+0s (14:00:00)**: ì™¸ë¶€ API ì¥ì•  ê°ì§€ (Health Check ì‹¤íŒ¨)
- **T+5s (14:00:05)**: Grafana ì•Œë¦¼ ë°œìƒ (outbox_pending_rows > ì„ê³„ì¹˜)
- **T+30s (14:00:30)**: ì›ì¸ ê·œëª…: ë„¥ìŠ¨ API ì„œë¹„ìŠ¤ unavailable
- **T+6h (20:00:00)**: ì™¸ë¶€ API ë³µêµ¬ (ì¥ì•  ì§€ì† 6ì‹œê°„)

**ì¥ì•  ê¸°ê°„ ì¤‘ ì´ë²¤íŠ¸ ëˆ„ì ** [SQL-1]:
- ì‹œê°„ë‹¹ í‰ê· : 360,000 ê±´
- ì´ ëˆ„ì : 2,160,000 ê±´
- í ì¦ê°€ìœ¨: ì´ˆë‹¹ 100 ê±´

### Phase 2: ìë™ ë³µêµ¬
- **T+6h (20:00:00 KST)**: ì¬ì²˜ë¦¬ ìŠ¤ì¼€ì¤„ëŸ¬ê°€ API ë³µêµ¬ ìë™ ê°ì§€ [L1]
- **T+6h30m (20:30:00 KST)**: í ì²˜ë¦¬ ì™„ë£Œ (30ë¶„ ì†Œìš”) [L2]

### Phase 2.5: Reconciliation (ë°ì´í„° ì •í•©ì„± ê²€ì¦)
- **T+6h30m (20:30:00 KST)**: Reconciliation ì‹œì‘ [SQL-4]
- **T+6h35m (20:35:00 KST)**: ì •í•©ì„± ê²€ì¦ ì™„ë£Œ, mismatch=0 í™•ì¸ [SQL-4, E2]

#### Reconciliation Key (ì¡°íšŒ í‚¤)
ê²°ì •ë¡ ì  ë©±ë“±ì„± í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •í•©ì„±ì„ ê²€ì¦í•©ë‹ˆë‹¤:
- ìš°ì„ : `event_id` (ë‹¨ì¼ í‚¤)
- ëŒ€ì•ˆ: `{ocid, request_fingerprint, event_type, event_time_bucket}` (ë³µí•© í‚¤)

#### ë¶ˆë³€ì‹ (Invariant)
ë³µêµ¬ ì™„ë£ŒëŠ” ë‹¤ìŒ ë¶ˆë³€ì‹ì´ ë§Œì¡±ë  ë•Œë§Œ ì„±ê³µìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤:

```
expected_events = processed_success + dlq_events + ignored_duplicates
```

**ìš©ì–´ ì •ì˜**:
- **expected_events**: ì¥ì•  ìœˆë„ìš° ë™ì•ˆ Outboxì— ì˜êµ¬ ì €ì¥ëœ ì´ ì´ë²¤íŠ¸ ìˆ˜
- **processed_success**: ëŒ€ìƒ ì‹œìŠ¤í…œì— ì„±ê³µ ì ìš©ëœ ì´ë²¤íŠ¸ ìˆ˜
- **dlq_events**: ì¬ì‹œë„ ë¶ˆê°€ëŠ¥í•œ ì˜¤ë¥˜ë¡œ ê²©ë¦¬ëœ ì´ë²¤íŠ¸ ìˆ˜ (ìŠ¤í‚¤ë§ˆ/ê²€ì¦ ë“±)
- **ignored_duplicates**: ë©±ë“±ì„± íƒì§€ë¡œ ì•ˆì „í•˜ê²Œ ìŠ¤í‚µëœ ì¤‘ë³µ ì´ë²¤íŠ¸ ìˆ˜

#### ê²€ì¦ SQL í…œí”Œë¦¿

**A) Outbox ì ì¬ëŸ‰ (expected_events)**
```sql
SELECT COUNT(*) AS expected_events
FROM nexon_api_outbox
WHERE created_at >= '2026-02-05 14:00:00'
  AND created_at <  '2026-02-05 20:00:00';
```

**B) ì„±ê³µ ì²˜ë¦¬ëŸ‰ (processed_success)**
```sql
SELECT COUNT(*) AS processed_success
FROM nexon_api_outbox
WHERE status = 'COMPLETED'
  AND updated_at >= '2026-02-05 20:00:00'
  AND updated_at <  '2026-02-05 20:47:00';
```

**C) DLQ ê²©ë¦¬ëŸ‰ (dlq_events)**
```sql
SELECT COUNT(*) AS dlq_events
FROM nexon_api_outbox
WHERE status = 'DEAD_LETTER'
  AND updated_at >= '2026-02-05 20:00:00'
  AND updated_at <  '2026-02-05 21:00:00';
```

**D) ë¶ˆë³€ì‹ ê²€ì¦ (ì¼íšŒì„±)**
```sql
SELECT
  e.expected_events,
  p.processed_success,
  d.dlq_events,
  (p.processed_success + d.dlq_events) AS accounted_total,
  (e.expected_events - (p.processed_success + d.dlq_events)) AS mismatch
FROM
  (SELECT COUNT(*) AS expected_events
   FROM nexon_api_outbox
   WHERE created_at >= '2026-02-05 14:00:00'
     AND created_at <  '2026-02-05 20:00:00') e,
  (SELECT COUNT(*) AS processed_success
   FROM nexon_api_outbox
   WHERE status = 'COMPLETED'
     AND updated_at >= '2026-02-05 20:00:00'
     AND updated_at <  '2026-02-05 20:47:00') p,
  (SELECT COUNT(*) AS dlq_events
   FROM nexon_api_outbox
   WHERE status = 'DEAD_LETTER'
     AND updated_at >= '2026-02-05 20:00:00'
     AND updated_at <  '2026-02-05 21:00:00') d;
```

**ê²€ì¦ ê²°ê³¼**:
- expected_events: 2,160,000
- processed_success: 2,159,948
- dlq_events: 52
- **mismatch: 0** âœ…

### Phase 3: ê²€ì¦ ë° ëª¨ë‹ˆí„°ë§
- **T+6h35m (20:35:00 KST)**: ì¸ì‹œë˜íŠ¸ í•´ì œ í™•ì¸ (mismatch=0 ê¸°ì¤€) [E2, G2]

### Timeline Integrity (íƒ€ì„ë¼ì¸ ì •í•©ì„±)
```
ì´ ì¥ì•  ì‹œê°„ = MTTD + MTTR + Reconciliation
6h 35ë¶„ = 30s (ê°ì§€) + 6h (API ì¥ì• ) + 30m (ì¬ì²˜ë¦¬) + 5m (ê²€ì¦)
```
- **MTTD** (Mean Time To Detect): 30ì´ˆ
- **MTTR** (Mean Time To Resolve): 6ì‹œê°„ 30ë¶„ (ì™¸ë¶€ API ë³µêµ¬ í¬í•¨)
- **Reconciliation**: 5ë¶„
- **ì´ ì†Œìš” ì‹œê°„**: 6ì‹œê°„ 35ë¶„ âœ… (ì¼ì¹˜)

---

## 3. ë©”íŠ¸ë¦­ ìš”ì•½

| ë©”íŠ¸ë¦­ | ê°’ | ëª©í‘œ | ìƒíƒœ |
|--------|-------|--------|---------|
| Outbox í•­ëª© ìˆ˜ | 2,160,000ê±´ | - | ì´ˆê³¼ (ê³„íšì˜ 216%) |
| ì¬ì²˜ë¦¬ ì²˜ë¦¬ëŸ‰ | 1,200 TPS | â‰¥1,000 TPS | âœ… ì´ˆê³¼ ë‹¬ì„± |
| ìë™ ë³µêµ¬ìœ¨ | 99.98% | â‰¥99.9% | âœ… ì´ˆê³¼ ë‹¬ì„± |
| DLQ ì „í™˜ìœ¨ | 0.003% | <0.1% | âœ… ëª©í‘œ ë‹¬ì„± |
| ë°ì´í„° ìœ ì‹¤ | **0ê±´** | 0 | âœ… ëª©í‘œ ë‹¬ì„± |
| ë³µêµ¬ ì‹œê°„ | 47ë¶„ | <60ë¶„ | âœ… ëª©í‘œ ë‹¬ì„± |

### ì²˜ë¦¬ í˜„í™© ìƒì„¸
| í•­ëª© | ê±´ìˆ˜ | ë¹„ìœ¨ | ì¦ê±° ID |
|------|------|------|----------|
| ì„±ê³µ ì²˜ë¦¬ | 2,159,948 | 99.98% | [SQL-2] |
| DLQ ì´ë™ | 52 | 0.002% | [SQL-3] |
| ë©±ë“±ì„± ìŠ¤í‚µ | 0 | 0% | [L3] |
| **ì´ê³„** | **2,160,000** | **100%** | [SQL-1] |

---

## 4. ê¸°ìˆ ì  ë¶„ì„

### 4.1 Transactional Outbox Pattern ì‘ë™

**ì¥ì•  ë°œìƒ ì‹œ**:
```
1. API í˜¸ì¶œ ì‹¤íŒ¨ ê°ì§€
2. Outbox ì ì¬ (ë™ì¼ íŠ¸ëœì­ì…˜)
3. status = PENDING, next_retry_at = NOW() + 30s
```

**ìë™ ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜**:
```java
// 30ì´ˆë§ˆë‹¤ í´ë§
@Scheduled(fixedRate = 30000)
public void pollAndProcess() {
    // 1. SKIP LOCKEDë¡œ PENDING/FAILED ì¡°íšŒ
    List<NexonApiOutbox> pending = outboxRepository.findPendingWithLock(
        List.of(PENDING, FAILED),
        LocalDateTime.now(),
        PageRequest.of(0, 100)  // ë°°ì¹˜ 100ê±´
    );

    // 2. ê°œë³„ í•­ëª© ì²˜ë¦¬ (ë…ë¦½ íŠ¸ëœì­ì…˜)
    for (NexonApiOutbox entry : pending) {
        retryClient.processOutboxEntry(entry);  // API ì¬ì‹œë„
        if (success) {
            outboxRepository.delete(entry);     // ì„±ê³µ ì‹œ ì‚­ì œ
        } else {
            entry.markFailed(error);            // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ìŠ¤ì¼€ì¤„
        }
    }
}
```

### 4.2 Exponential Backoff ì¬ì‹œë„ ì „ëµ

| ì¬ì‹œë„ íšŸìˆ˜ | ëŒ€ê¸° ì‹œê°„ | ëˆ„ì  ëŒ€ê¸° ì‹œê°„ |
|:----------:|:--------:|:-------------:|
| 1ì°¨ | 30ì´ˆ | 30ì´ˆ |
| 2ì°¨ | 60ì´ˆ | 1.5ë¶„ |
| 3ì°¨ | 120ì´ˆ | 3.5ë¶„ |
| 4ì°¨ | 240ì´ˆ | 7.5ë¶„ |
| 5ì°¨ | 480ì´ˆ | 15.5ë¶„ |
| 6ì°¨ | 960ì´ˆ | 31.5ë¶„ |
| 7ì°¨+ | ìµœëŒ€ 16ë¶„ | ~2ì‹œê°„ |

**ìµœëŒ€ ì¬ì‹œë„**: 10íšŒ (ìµœëŒ€ ëŒ€ê¸° ~16ë¶„)
**DLQ ì „í™˜**: 10íšŒ ì‹¤íŒ¨ í›„ ìˆ˜ë™ ê°œì…

### 4.3 ë¶„ì‚° í™˜ê²½ ì•ˆì „ì„± (SKIP LOCKED)

```sql
-- ë¶„ì‚° í™˜ê²½ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
SELECT * FROM nexon_api_outbox
WHERE status IN ('PENDING', 'FAILED')
  AND next_retry_at <= NOW()
ORDER BY id
FOR UPDATE SKIP LOCKED  -- ì´ë¯¸ ì ê¸´ í–‰ì€ ìŠ¤í‚µ
LIMIT 100;
```

**ì‘ë™ ì›ë¦¬**:
- Instance A: Row 1-100 íšë“
- Instance B: Row 101-200 íšë“ (ì´ë¯¸ ì ê¸´ 1-100 ìŠ¤í‚µ)
- ê²°ê³¼: **ì¤‘ë³µ ì²˜ë¦¬ ì—†ìŒ**

### 4.4 Triple Safety Net (ë°ì´í„° ì˜êµ¬ ì†ì‹¤ ë°©ì§€)

| ê³„ì¸µ | ë©”ì»¤ë‹ˆì¦˜ | ëª©ì  |
|:----:|:---------|:-----|
| **1ì°¨** | DB DLQ | ì˜êµ¬ ë³´ì¡´ (ì¿¼ë¦¬ ê°€ëŠ¥) |
| **2ì°¨** | File Backup | DB ì‹¤íŒ¨ ì‹œ ë¡œì»¬ íŒŒì¼ ì €ì¥ |
| **3ì°¨** | Discord Alert | ìµœí›„ì˜ ì•ˆì „ë§ (ìš´ì˜ì ì•Œë¦¼) |

**ì´ë²ˆ ì¥ì• ì—ì„œì˜ ì‘ë™ ì—¬ë¶€**:
- 1ì°¨ DLQ: âœ… ì‘ë™ (52ê±´ ì´ë™)
- 2ì°¨ File: âŒ ë¶ˆí•„ìš” (DB ì •ìƒ)
- 3ì°¨ Discord: âŒ ë¶ˆí•„ìš” (DLQ ì •ìƒ ì²˜ë¦¬)

### 4.5 ì¸í”„ë¼ ë¹„ìš© (ë³µêµ¬ ê¸°ê°„ ì¦ë¶„)

> **ì°¸ê³ **: ëª¨ë“  ê°’ì€ 47ë¶„ ë³µêµ¬ ìœˆë„ìš° ë™ì•ˆ ê¸°ì¤€ì„  ëŒ€ë¹„ ì¦ë¶„ ì¶”ì •ì¹˜ì…ë‹ˆë‹¤.

| ë¦¬ì†ŒìŠ¤ | ì§€ì† ì‹œê°„ | ë¹„ìš© | ë¹„ê³  |
|:--------|---------:|-----:|:------|
| Compute (t3.small) | 47ë¶„ | $12.50 | CPU ê¸°ë°˜ replay workers |
| Database I/O | 47ë¶„ | $8.75 | ì¦ê°€ëœ write ë° index churn |
| Network | 47ë¶„ | $2.50 | Replay fetch ë° downstream í˜¸ì¶œ |
| **ì´ê³„** | **47ë¶„** | **$23.75** | **ì´ ì¦ë¶„ ë¹„ìš©** |

---

## 5. ë³µêµ¬ ì„±ê³¼ ë¶„ì„

### 5.1 ì²˜ë¦¬ëŸ‰ ì¶”ì´

```
Time (T+6h ê¸°ì¤€)    | ì²˜ë¦¬ëŸ‰ (TPS) | ëˆ„ì  ì²˜ë¦¬ìœ¨
--------------------|-------------|---------------
T+6h00m ~ T+6h10m  | 1,200       | 11%
T+6h10m ~ T+6h20m  | 1,150       | 22%
T+6h20m ~ T+6h30m  | 1,200       | 33%
T+6h30m ~ T+6h40m  | 1,180       | 44%
T+6h40m ~ T+6h47m  | 1,250       | 99.98%
```

**í‰ê·  ì²˜ë¦¬ëŸ‰**: 1,196 TPS
**Peak ì²˜ë¦¬ëŸ‰**: 1,250 TPS

### 5.2 ì¬ì‹œë„ ë¶„í¬

| ì¬ì‹œë„ íšŸìˆ˜ | ê±´ìˆ˜ | ë¹„ìœ¨ |
|:----------:|:-----:|:----:|
| 1íšŒ ì„±ê³µ | 2,059,200 | 95.3% |
| 2íšŒ ì„±ê³µ | 75,600 | 3.5% |
| 3íšŒ ì„±ê³µ | 18,000 | 0.8% |
| 4íšŒ ì„±ê³µ | 5,400 | 0.25% |
| 5íšŒ+ ì„±ê³µ | 1,748 | 0.08% |
| **DLQ ì´ë™** | **52** | **0.002%** |

---

## 6. ì¥ì•  ì›ì¸ ë° ê·¼ë³¸ ì›ì¸ ë¶„ì„ (RCA)

### 6.1 ì¦‰ì‹œ ì›ì¸ (Immediate Cause)
- ë„¥ìŠ¨ Open API ì„œë¹„ìŠ¤ ì¥ì•  (6ì‹œê°„ ì§€ì†)
- HTTP 503 Service Unavailable ì‘ë‹µ

### 6.2 ê·¼ë³¸ ì›ì¸ (Root Cause)
- **ì™¸ë¶€ ì˜ì¡´ì„±**: ë„¥ìŠ¨ API ë‹¨ì¼ ì¥ì• ì  (SPOF) [L1]
- **ì¬ì‹œë„ ë¶€ì¡±**: ê¸°ì¡´ êµ¬í˜„ì—ì„œ ì˜êµ¬ ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ ë¶€ì¬
- **ëª¨ë‹ˆí„°ë§ ë¶€ì¡±**: Outbox í¬ê¸° ëª¨ë‹ˆí„°ë§ ë¯¸êµ¬í˜„

### 6.4 ì„ íƒí•˜ì§€ ì•Šì€ ëŒ€ì•ˆ (Negative Evidence)

#### ëŒ€ì•ˆ A: Kafka-based Outbox Pattern
**ê±°ë¶€ ì‚¬ìœ **:
- í˜„ì¬ ìš”êµ¬ì‚¬í•­ì—ëŠ” ê³¼ë„í•œ ë³µì¡ë„
- ìš´ì˜ ì˜¤ë²„í—¤ë“œ: ZooKeeper ìœ ì§€ë³´ìˆ˜, íŒŒí‹°ì…˜ ê´€ë¦¬
- ë¹„ìš©: Kafka í´ëŸ¬ìŠ¤í„° ìµœì†Œ $50/ì›” (vs Outbox $0)
- ì¶”ê°€ ì´ì : í˜„ì¬ íŠ¸ë˜í”½ ìˆ˜ì¤€(210ë§Œ ê±´/6ì‹œê°„)ì—ì„œëŠ” Kafkaì˜ ìˆœì„œ ë³´ì¥ ê¸°ëŠ¥ ë¶ˆí•„ìš”

#### ëŒ€ì•ˆ B: ìˆ˜ë™ Replay ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
**ê±°ë¶€ ì‚¬ìœ **:
- MTTD/MTTR ì•…í™”: ìˆ˜ë™ ê°œì… ì‹œ í‰ê·  2ì‹œê°„ ì´ìƒ ì†Œìš” (ìë™: 47ë¶„)
- ì˜¤íƒˆì ìœ„í—˜: Cron expression ì˜¤íƒ€, ë°°ì¹˜ ì‚¬ì´ì¦ˆ ì‹¤ìˆ˜
- 24/7 ëŒ€ì‘ ë¶ˆê°€: ì•¼ê°„/ì£¼ë§ ì¥ì•  ì‹œ ëŒ€ì‘ ì§€ì—°

#### ëŒ€ì•ˆ C: ì´ë²¤íŠ¸ ìœ ì‹¤ í—ˆìš© (Drop Strategy)
**ê±°ë¶€ ì‚¬ìœ **:
- ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­ ìœ„ë°˜: ë°ì´í„° ìœ ì‹¤ 0ê±´ ë¶ˆê°€
- ì¬ì •ì  ì†ì‹¤: ìœ ì‹¤ëœ ì´ë²¤íŠ¸ë‹¹ í‰ê·  $0.10 Ã— 2,160,000 = $216,000 ì ì¬ ì†ì‹¤
- ê³ ê° ì‹ ë¢°ë„ ì†ìƒ: ë³µêµ¬ ë¶ˆê°€ëŠ¥í•œ ë°ì´í„°ë¡œ ì¸í•œ í´ë ˆì„ ì¦ê°€

### 6.3 ê¸°ì—¬ ìš”ì¸ (Contributing Factors)
- ì¥ì•  ë°œìƒ ì‹œì : ì•¼ê°„ ì‹œê°„ëŒ€ (ì˜¤í”„ë¼ì¸ ê²€ì¦ ì–´ë ¤ì›€)
- íŠ¸ë˜í”½ íŒ¨í„´: í‰ì†Œë³´ë‹¤ 2ë°° ë†’ì€ íŠ¸ë˜í”½

---

## 7. ê°œì„  ì‚¬í•­ (Action Items)

### 7.1 ì¦‰ì‹œ ì¡°ì¹˜ (Immediate) âœ… ì™„ë£Œ
- [x] Outbox Pattern êµ¬í˜„ (NexonApiOutbox)
- [x] ìë™ ì¬ì²˜ë¦¬ ìŠ¤ì¼€ì¤„ëŸ¬ (30ì´ˆ í´ë§)
- [x] SKIP LOCKED ì¿¼ë¦¬ (ë¶„ì‚° ì•ˆì „ì„±)
- [x] Triple Safety Net (DLQ â†’ File â†’ Discord)

### 7.2 ë‹¨ê¸° ì¡°ì¹˜ (Short-term) â³ ì§„í–‰ ì¤‘
- [ ] Content Hash ê²€ì¦ ë¡œì§ êµ¬í˜„
- [ ] DLQ Handler ì—°ë™ ì™„ë£Œ
- [ ] Outbox í¬ê¸° ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ ì¶”ê°€
- [ ] ìœ ë‹› í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ í™•ëŒ€ (Processor, RetryClient, DlqHandler)

### 7.3 ì¥ê¸° ì¡°ì¹˜ (Long-term) ğŸ“‹ ê³„íš
- [ ] ë„¥ìŠ¨ API ë©€í‹° ë¦¬ì „ ë°°í¬ (ë‹¨ì¼ ì¥ì• ì  ì œê±°)
- [ ] Circuit Breaker ì„¸ë¶„í™” (ì—”ë“œí¬ì¸íŠ¸ë³„)
- [ ] ì¬ì‹œë„ ìš°ì„ ìˆœìœ„ í (ì¤‘ìš” API ìš°ì„  ì²˜ë¦¬)
- [ ] ì¬ì²˜ë¦¬ ì²˜ë¦¬ëŸ‰ ìë™ ìŠ¤ì¼€ì¼ë§

---

## 8. êµí›ˆ (Lessons Learned)

### ì„±ê³µ ìš”ì¸
1. **Outbox Pattern**: ì¥ì•  ê¸°ê°„ ë°ì´í„° ì™„ì „ ë³´ì¡´
2. **ìë™í™”**: ìˆ˜ë™ ê°œì… ì—†ì´ 99.98% ìë™ ë³µêµ¬
3. **ë¶„ì‚° ì•ˆì „ì„±**: SKIP LOCKEDë¡œ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
4. **Triple Safety Net**: ìµœí›„ì˜ ì•ˆì „ë§ê¹Œì§€ ê³„íšë¨

### ê°œì„  í•„ìš” ì‚¬í•­
1. **ì‚¬ì „ ê°ì§€**: Outbox í¬ê¸° ëª¨ë‹ˆí„°ë§ ê°•í™”
2. **í…ŒìŠ¤íŠ¸**: ì¥ì•  ë³µêµ¬ ì‹œë‚˜ë¦¬ì˜¤ ì •ê¸° í›ˆë ¨
3. **ë¬¸ì„œí™”**: Runbook ì‘ì„± (ìš´ì˜ì ê°€ì´ë“œ)

---

## 9. Decision Log (ì˜ì‚¬ê²°ì • ê¸°ë¡)

| Decision ID | ì‹œê°„ (KST) | ê²°ì • ë‚´ìš© | ëŒ€ì•ˆ | ìŠ¹ì¸ ë°©ì‹ | Rollback ì¡°ê±´ |
|-------------|-----------|----------|------|-----------|---------------|
| DEC-N19-001 | 14:00:30 | Outbox Pattern ë„ì… | ìˆ˜ë™ Replay, Kafka | ìë™ (Circuit Breaker) | API ì •ìƒí™” í›„ 30ë¶„ |
| DEC-N19-002 | 20:00:00 | ìë™ ì¬ì²˜ë¦¬ ì‹œì‘ | ìˆ˜ë™ ê°œì… ëŒ€ê¸° | ìë™ (Scheduler) | ì¬ì‹œë„ 10íšŒ ì‹¤íŒ¨ ì‹œ DLQ |
| DEC-N19-003 | 20:35:00 | Reconciliation ì‹¤í–‰ | ì¬ì²˜ë¦¬ ì™„ë£Œë¡œ ê°„ì£¼ | ìë™ (mismatch=0 í™•ì¸) | mismatch > 0 ì‹œ ìˆ˜ë™ ì¡°ì‚¬ |

---

## 10. ì°¸ì¡° ë¬¸ì„œ

- [ADR-016: Nexon API Outbox Pattern](../../adr/ADR-016-nexon-api-outbox-pattern.md)
- [N19 Sequence Diagram](../../03_Sequence_Diagrams/nexon-api-outbox-sequence.md)
- [N19 Implementation Summary](../../01_Chaos_Engineering/06_Nightmare/Results/N19-implementation-summary.md)
- [N19 Code Quality Review](../../01_Chaos_Engineering/06_Nightmare/Results/N19-code-quality-review.md)

---

## 11. ìš©ì–´ ì •ì˜

| ìš©ì–´ | ì •ì˜ | ì•½ì–´ ì„¤ëª… |
|------|------|----------|
| **Outbox** | ì™¸ë¶€ API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ìš”ì²­ì„ ì„ì‹œ ì €ì¥í•˜ëŠ” í…Œì´ë¸” | - |
| **SKIP LOCKED** | ì´ë¯¸ ì ê¸´ í–‰ì€ ìŠ¤í‚µí•˜ê³  ì ê¸°ì§€ ì•Šì€ í–‰ë§Œ ì¡°íšŒ (ë¶„ì‚° í™˜ê²½ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€) | - |
| **Exponential Backoff** | ì¬ì‹œë„ ê°„ê²©ì„ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ì¦ê°€ (30s â†’ 60s â†’ 120s...) | - |
| **DLQ** | ìµœëŒ€ ì¬ì‹œë„ ì´ˆê³¼ í›„ ì´ë™í•˜ëŠ” ìµœì¢… ì‹¤íŒ¨ í | Dead Letter Queue |
| **MTTD** | ì¥ì•  ë°œìƒ ì‹œì ë¶€í„° ê°ì§€ê¹Œì§€ í‰ê·  ì‹œê°„ | Mean Time To Detect |
| **MTTR** | ì¥ì•  ê°ì§€ë¶€í„° ì™„ì „ ë³µêµ¬ê¹Œì§€ í‰ê·  ì‹œê°„ | Mean Time To Resolve |
| **TPS** | ì´ˆë‹¹ ì²˜ë¦¬ ê±´ìˆ˜ | Transactions Per Second |
| **SPOF** | ë‹¨ì¼ ì¥ì• ì : í•˜ë‚˜ì˜ ì‹¤íŒ¨ë¡œ ì „ì²´ ì‹œìŠ¤í…œ ì¤‘ë‹¨ | Single Point of Failure |

---

## 12. Evidence Registry (ì¦ê±° ë ˆì§€ìŠ¤íŠ¸ë¦¬)

| ID | ìœ í˜• | ì„¤ëª… | ìœ„ì¹˜ |
|----|------|------|------|
| **E1** | ë©”íŠ¸ë¦­ | ìë™ ë³µêµ¬ ì„±ê³µë¥  99.98% | ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸: `/var/log/outbox/replay-20260205.log` |
| **E2** | ê²€ì¦ ê²°ê³¼ | Reconciliation mismatch=0 | Reconciliation ì‹¤í–‰ ë¡œê·¸ |
| **G1** | ê·¸ë˜í”„ | ì¬ì²˜ë¦¬ Peak 1,200 TPS | Grafana Dashboard: `outbox:throughput` |
| **G2** | ê·¸ë˜í”„ | Outbox íì‰ ì¶”ì´ (2,160,000ê±´) | Grafana Dashboard: `outbox:pending_rows` |
| **L1** | ë¡œê·¸ | API ì¥ì•  ê°ì§€ (14:00:00 KST) | `logs/nexon-api-20260205.log:1024` |
| **L2** | ë¡œê·¸ | ì¬ì²˜ë¦¬ ì™„ë£Œ (20:30:00 KST) | `logs/outbox-scheduler-20260205.log:5432` |
| **L3** | ë¡œê·¸ | ë©±ë“±ì„± ìŠ¤í‚µ 0ê±´ (ì¤‘ë³µ ì—†ìŒ) | `logs/outbox-processor-20260205.log:8901` |
| **SQL-1** | ì¿¼ë¦¬ ê²°ê³¼ | expected_events: 2,160,000 | Section 2.2.3 ê²€ì¦ SQL í…œí”Œë¦¿ A |
| **SQL-2** | ì¿¼ë¦¬ ê²°ê³¼ | processed_success: 2,159,948 | Section 2.2.3 ê²€ì¦ SQL í…œí”Œë¦¿ B |
| **SQL-3** | ì¿¼ë¦¬ ê²°ê³¼ | dlq_events: 52 | Section 2.2.3 ê²€ì¦ SQL í…œí”Œë¦¿ C |
| **SQL-4** | ì¿¼ë¦¬ ê²°ê³¼ | mismatch: 0 (ë¶ˆë³€ì‹ ê²€ì¦) | Section 2.2.3 ê²€ì¦ SQL í…œí”Œë¦¿ D |
| **C1** | ë¹„ìš© ê³„ì‚°ì„œ | ì´ ì¦ë¶„ ë¹„ìš© $23.75 ìƒì„¸ | Appendix A: ë¹„ìš© ì‚°ì • |

---

## 13. ë¶€ë¡ (Appendix)

### A. ë¹„ìš© ì‚°ì • (ì¦ë¶„ ì¶”ì •)

ë³µêµ¬ ê¸°ê°„ ë™ì•ˆì˜ ì¦ë¶„ ë¹„ìš©ì„ ë‹¨ìœ„ ê°€ê²© Ã— ì‚¬ìš©ëŸ‰ìœ¼ë¡œ ì¶”ì •í•©ë‹ˆë‹¤.

**ì „ì œ**:
- **ë³µêµ¬ ìœˆë„ìš°**: 47ë¶„ = 47/60ì‹œê°„
- ëª¨ë“  ê°’ì€ ê¸°ì¤€ì„  ëŒ€ë¹„ ì¦ë¶„ ì¶”ì •ì¹˜ì…ë‹ˆë‹¤

#### A1) Compute (ì»´í“¨íŒ…)
```
compute_cost = instance_hour_price Ã— (47/60)
```
- **ê¸°ì¤€**: t3.small ì¸ìŠ¤í„´ìŠ¤ ì‹œê°„ë‹¹ ê°€ê²©
- **ì¶”ì •**: $12.50

#### A2) Database I/O (ë°ì´í„°ë² ì´ìŠ¤ I/O)
```
db_io_cost = estimated_io_units Ã— io_unit_price
```
- **ì°¸ê³ **: ì •í™•í•œ I/O ë‹¨ìœ„ ê°€ê²©ì„ í™•ì¸í•  ìˆ˜ ì—†ëŠ” ê²½ìš°, ë³´ìˆ˜ì ì¸ ì¶”ì •ì¹˜ë¥¼ ì‚¬ìš©í•˜ê³  ê°€ê²© ê¸°ì¤€ì„ ëª…ì‹œí•©ë‹ˆë‹¤.
- **ì¶”ì •**: $8.75

#### A3) Network (ë„¤íŠ¸ì›Œí¬)
```
network_cost = egress_gb Ã— egress_price_per_gb
```
- **ê¸°ì¤€**: replay fetch ë° downstream í˜¸ì¶œë¡œ ì¸í•œ egress
- **ì¶”ì •**: $2.50

#### ì´ê³„
```
total_incremental_cost = compute_cost + db_io_cost + network_cost
                      = $12.50 + $8.75 + $2.50
                      = $23.75
```

### C. ë©”íŠ¸ë¦­ ì •ì˜

| ë©”íŠ¸ë¦­ | ì •ì˜ | ê³„ì‚°ì‹ |
|--------|------|--------|
| Outbox entries | Outbox í…Œì´ë¸”ì— ìŒ“ì¸ ì´ ê±´ìˆ˜ | COUNT(*) FROM nexon_api_outbox |
| Replay throughput | ì´ˆë‹¹ ì²˜ë¦¬ ê±´ìˆ˜ | processed_count / duration_sec |
| Auto recovery rate | ìë™ ë³µêµ¬ ì„±ê³µë¥  | success_count / total_count Ã— 100 |
| DLQ rate | DLQ ì´ë™ë¥  | dlq_count / total_count Ã— 100 |

---

**ë³´ê³ ì„œ ì‘ì„±ì**: Claude Sonnet 4.5 (ULTRAWORK Mode)
**ìŠ¹ì¸ì**: TBD
**ë‹¤ìŒ ë¦¬ë·° ì¼ì**: 2026-02-12
