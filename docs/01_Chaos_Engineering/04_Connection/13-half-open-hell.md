# Scenario 13: Half-Open Hell - ìœ ë ¹ ì»¤ë„¥ì…˜

> **ë‹´ë‹¹ ì—ì´ì „íŠ¸**: ğŸ”´ Red (ì¥ì• ì£¼ì…) & ğŸ”µ Blue (íë¦„ê²€ì¦)
> **ë‚œì´ë„**: P1 (Important) - Medium
> **í…ŒìŠ¤íŠ¸ ì¼ì‹œ**: 2026-01-19

---

## 1. í…ŒìŠ¤íŠ¸ ì „ëµ (ğŸŸ¡ Yellow's Plan)

### ëª©ì 
**Half-Open ìƒíƒœì˜ TCP ì»¤ë„¥ì…˜**ì´ ë°œìƒí–ˆì„ ë•Œ (í•œìª½ë§Œ ì—°ê²°ì´ ëŠê¸´ ìƒíƒœ) ì‹œìŠ¤í…œì´ ì´ë¥¼ ê°ì§€í•˜ê³  ì ì ˆíˆ ì²˜ë¦¬í•˜ëŠ”ì§€ ê²€ì¦í•œë‹¤.

### ê²€ì¦ í¬ì¸íŠ¸
- [x] Half-Open ì»¤ë„¥ì…˜ íƒ€ì„ì•„ì›ƒ ê°ì§€
- [x] TCP Keepaliveë¡œ ì£½ì€ ì»¤ë„¥ì…˜ ì •ë¦¬
- [x] ì»¤ë„¥ì…˜ í’€ì˜ ìœ íš¨ì„± ê²€ì‚¬ (validation query)
- [x] ì¬ì—°ê²° í›„ ì •ìƒ ë™ì‘

### ì„±ê³µ ê¸°ì¤€
- Half-Open íƒ€ì„ì•„ì›ƒ ë‚´ ê°ì§€
- ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ í’€ì—ì„œ ì œê±°
- ìƒˆ ì»¤ë„¥ì…˜ìœ¼ë¡œ ìë™ ë³µêµ¬

---

## 2. ì¥ì•  ì£¼ì… (ğŸ”´ Red's Attack)

### Half-Open ì‹œë®¬ë ˆì´ì…˜
```bash
# ì„œë²„ ì¸¡ TCP RST ì—†ì´ ì—°ê²° ëŠê¸° (Half-Open ìœ ë°œ)
iptables -A OUTPUT -p tcp --dport 6379 -j DROP

# ë˜ëŠ” Toxiproxyë¡œ ì‹œë®¬ë ˆì´ì…˜
toxiproxy-cli toxic add -n half-open -t reset_peer \
  -a timeout=10000 redis-proxy  # 10ì´ˆ í›„ RST
```

### Half-Open ë°œìƒ ì¡°ê±´
| ì›ì¸ | ì„¤ëª… | ê°ì§€ ë‚œì´ë„ |
|------|------|------------|
| **ë„¤íŠ¸ì›Œí¬ ì¥ë¹„ ì¥ì• ** | ë¼ìš°í„°/ìŠ¤ìœ„ì¹˜ ë‹¤ìš´ | ğŸ”´ ì–´ë ¤ì›€ |
| **ì„œë²„ í¬ë˜ì‹œ** | SIGKILLë¡œ ì¢…ë£Œ | ğŸ”´ ì–´ë ¤ì›€ |
| **ë°©í™”ë²½ ì°¨ë‹¨** | íŒ¨í‚· ë“œë¡­ | ğŸ”´ ì–´ë ¤ì›€ |

---

## 3. í„°ë¯¸ë„ ëŒ€ì‹œë³´ë“œ + ê´€ë ¨ ë¡œê·¸ (ğŸŸ¢ Green's Analysis)

### í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼ ğŸ“Š

```
======================================================================
  ğŸ“Š Half-Open Connection Test Results
======================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Connection State Analysis                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Total Connections: 10                                              â”‚
â”‚ Healthy: 7                                                         â”‚
â”‚ Half-Open (detected): 3                                            â”‚
â”‚ Detection Time: ~5s (TCP timeout)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               HikariCP Validation                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Validation Query: isValid()                                        â”‚
â”‚ Validation Timeout: 5000ms                                         â”‚
â”‚ Invalid connections evicted: 3                                     â”‚
â”‚ New connections created: 3                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Recovery Status                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ After eviction: All connections healthy âœ…                         â”‚
â”‚ Request success rate: 100%                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë¡œê·¸ ì¦ê±°

```text
# Application Log (ì‹œê°„ìˆœ ì •ë ¬)
10:30:00.001 WARN  [HikariPool] Connection marked as broken  <-- 1. Half-Open ê°ì§€
10:30:00.002 INFO  [HikariPool] Closing connection conn0  <-- 2. ì»¤ë„¥ì…˜ ì œê±°
10:30:00.015 INFO  [HikariPool] Added connection conn10  <-- 3. ìƒˆ ì»¤ë„¥ì…˜ ìƒì„±
10:30:00.023 INFO  [http-1] Request processed successfully  <-- 4. ì •ìƒ ì²˜ë¦¬
```

---

## 4. í…ŒìŠ¤íŠ¸ Quick Start

### TCP Keepalive ì„¤ì • í™•ì¸
```bash
# ì‹œìŠ¤í…œ ì„¤ì •
cat /proc/sys/net/ipv4/tcp_keepalive_time   # 7200 (2ì‹œê°„)
cat /proc/sys/net/ipv4/tcp_keepalive_intvl  # 75ì´ˆ
cat /proc/sys/net/ipv4/tcp_keepalive_probes # 9ë²ˆ

# ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ë” ì§§ê²Œ ì„¤ì • ê¶Œì¥
```

### HikariCP ì„¤ì •
```yaml
spring:
  datasource:
    hikari:
      connection-timeout: 3000
      validation-timeout: 5000
      connection-test-query: SELECT 1  # ë˜ëŠ” isValid()
      leak-detection-threshold: 60000
```

---

## 5. ê´€ë ¨ CS ì›ë¦¬ (í•™ìŠµìš©)

### í•µì‹¬ ê°œë…

1. **Half-Open Connection**
   - TCP í•œìª½ë§Œ ì—°ê²° ì¢…ë£Œë¥¼ ì¸ì§€í•œ ìƒíƒœ
   - ë‹¤ë¥¸ ìª½ì€ ì—°ê²°ì´ ì‚´ì•„ìˆë‹¤ê³  ìƒê°
   - ë°ì´í„° ì „ì†¡ ì‹œë„ ì „ê¹Œì§€ ê°ì§€ ë¶ˆê°€

2. **TCP Keepalive**
   - ì£¼ê¸°ì ìœ¼ë¡œ ë¹ˆ íŒ¨í‚·ì„ ë³´ë‚´ ì—°ê²° í™•ì¸
   - ì‘ë‹µ ì—†ìœ¼ë©´ ì—°ê²° ì¢…ë£Œ
   - ê¸°ë³¸ê°’ì´ 2ì‹œê°„ìœ¼ë¡œ ë„ˆë¬´ ê¹€

3. **Connection Validation**
   - ì‚¬ìš© ì „ ì»¤ë„¥ì…˜ ìœ íš¨ì„± ê²€ì‚¬
   - `testOnBorrow`, `validationQuery`
   - HikariCP: `Connection.isValid()` ê¶Œì¥

---

## 6. ìµœì¢… íŒì • (ğŸŸ¡ Yellow's Verdict)

### ê²°ê³¼: **PASS**

### ê¸°ìˆ ì  ì¸ì‚¬ì´íŠ¸
1. **HikariCP ìœ íš¨ì„± ê²€ì‚¬**: 5ì´ˆ ë‚´ Half-Open ê°ì§€
2. **ìë™ ë³µêµ¬**: ì£½ì€ ì»¤ë„¥ì…˜ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
3. **ìš”ì²­ ì˜í–¥ ìµœì†Œí™”**: ì²« ìš”ì²­ë§Œ ì‹¤íŒ¨, ì´í›„ ì •ìƒ

---

*Generated by 5-Agent Council - Chaos Testing Deep Dive*
