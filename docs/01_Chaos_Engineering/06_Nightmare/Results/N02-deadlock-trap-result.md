# Nightmare 02: Deadlock Trap - í…ŒìŠ¤íŠ¸ ê²°ê³¼

> **ì‹¤í–‰ì¼**: 2026-01-19
> **ê²°ê³¼**: âŒ **FAIL** (2/3 í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨)

---

## Test Evidence & Metadata

### ğŸ”— Evidence Links
- **Scenario**: [N02-deadlock-trap.md](../Scenarios/N02-deadlock-trap.md)
- **Test Class**: [DeadlockTrapNightmareTest.java](../../../src/test/java/maple/expectation/chaos/nightmare/DeadlockTrapNightmareTest.java)
- **Log File**: `logs/nightmare-02-20260119_HHMMSS.log`
- **GitHub Issue**: #[P0][Nightmare-02] Lock Ordering ë¯¸ì ìš©ìœ¼ë¡œ ì¸í•œ Deadlock ë°œìƒ

### ğŸ”§ Test Environment
| Parameter | Value |
|-----------|-------|
| Java Version | 21 |
| Spring Boot | 3.5.4 |
| MySQL | 8.0 (Docker) |
| InnoDB Version | 8.0 |
| Transaction Isolation | READ_COMMITTED |
| Lock Wait Timeout | 50s |

### ğŸ“Š Test Data Set
| Data Type | Description |
|-----------|-------------|
| Test Tables | `nightmare_table_a`, `nightmare_table_b` |
| Test Rows | 1 row per table (id=1) |
| Transaction Pattern | Cross-table UPDATE |
| Synchronization | CyclicBarrier (2 parties) |

### â±ï¸ Test Execution Details
| Metric | Value |
|--------|-------|
| Test Start Time | 2026-01-19 10:10:00 KST |
| Test End Time | 2026-01-19 10:12:00 KST |
| Total Duration | ~120 seconds |
| Deadlock Detection Time | ~50s (InnoDB timeout) |
| Individual Tests | 3 |

---

## í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½

| í…ŒìŠ¤íŠ¸ | ê²°ê³¼ | ì„¤ëª… |
|--------|------|------|
| êµì°¨ ë½ íšë“ ì‹œ Deadlock ë°œìƒ ì—¬ë¶€ | âŒ FAIL | Deadlock 1ê±´ ë°œìƒ |
| 10íšŒ ë°˜ë³µ ì‹œ Deadlock ë°œìƒ í™•ë¥  | âŒ FAIL | 100% ë°œìƒë¥  |
| Deadlock ë°œìƒ í›„ ë°ì´í„° ì •í•©ì„± | âœ… PASS | InnoDB ë¡¤ë°±ìœ¼ë¡œ ì¼ê´€ì„± ìœ ì§€ |

---

## ìƒì„¸ ê²°ê³¼

### Test 1: êµì°¨ ë½ íšë“ ì‹œ Deadlock ë°œìƒ ì—¬ë¶€ ê²€ì¦ âŒ
```
Nightmare 02: The Deadlock Trap - Circular Lock > êµì°¨ ë½ íšë“ ì‹œ Deadlock ë°œìƒ ì—¬ë¶€ ê²€ì¦ FAILED
    org.opentest4j.AssertionFailedError: [[Nightmare] Lock Orderingìœ¼ë¡œ Deadlock ë°©ì§€]
    expected: 0
     but was: 1
```

**ë¶„ì„**:
- Transaction A: TABLE_A â†’ TABLE_B ìˆœì„œë¡œ ë½ íšë“
- Transaction B: TABLE_B â†’ TABLE_A ì—­ìˆœìœ¼ë¡œ ë½ íšë“ ì‹œë„
- **ê²°ê³¼**: Circular Wait ì¡°ê±´ ì¶©ì¡± â†’ InnoDB Deadlock Detection ë°œë™

### Test 2: 10íšŒ ë°˜ë³µ ì‹œ Deadlock ë°œìƒ í™•ë¥  ì¸¡ì • âŒ
```
Nightmare 02: The Deadlock Trap - Circular Lock > 10íšŒ ë°˜ë³µ ì‹œ Deadlock ë°œìƒ í™•ë¥  ì¸¡ì • FAILED
    org.opentest4j.AssertionFailedError: [[Nightmare] Deadlock ë°œìƒë¥  0%%]
    expected: 0.0
     but was: 100.0
```

**ë¶„ì„**:
- 10íšŒ ë°˜ë³µ í…ŒìŠ¤íŠ¸ ê²°ê³¼ **100% Deadlock ë°œìƒ**
- CyclicBarrierë¡œ ì •í™•í•œ êµì°¨ íƒ€ì´ë° ì œì–´í•˜ì—¬ í™•ì‹¤í•˜ê²Œ ì¬í˜„ë¨
- Lock Ordering ë¯¸ì ìš©ìœ¼ë¡œ ì¸í•œ **í™•ì •ì  ì·¨ì•½ì **

### Test 3: Deadlock ë°œìƒ í›„ ë°ì´í„° ì •í•©ì„± ìœ ì§€ âœ…
```
Nightmare 02: The Deadlock Trap - Circular Lock > Deadlock ë°œìƒ í›„ ë°ì´í„° ì •í•©ì„± ìœ ì§€ PASSED
```

**ë¶„ì„**:
- InnoDB Deadlock Detectionì´ Victim íŠ¸ëœì­ì…˜ ë¡¤ë°±
- ë¡¤ë°± í›„ ë°ì´í„° ì¼ê´€ì„± ìœ ì§€ë¨
- ACID Atomicity ì›ì¹™ ì¤€ìˆ˜ í™•ì¸

---

## ê·¼ë³¸ ì›ì¸ ë¶„ì„

### Coffman Conditions (êµì°© ìƒíƒœ 4ê°€ì§€ ì¡°ê±´) ì¶©ì¡± ì—¬ë¶€

| ì¡°ê±´ | ì¶©ì¡± | ì„¤ëª… |
|------|------|------|
| Mutual Exclusion | âœ… | InnoDB Row Lock |
| Hold and Wait | âœ… | TABLE_A ë³´ìœ  ìƒíƒœì—ì„œ TABLE_B ëŒ€ê¸° |
| No Preemption | âœ… | íŠ¸ëœì­ì…˜ì´ ë½ì„ ìë°œì ìœ¼ë¡œ í•´ì œí•˜ì§€ ì•ŠìŒ |
| **Circular Wait** | âœ… | Aâ†’B, Bâ†’A ìˆœí™˜ ëŒ€ê¸° |

**ê²°ë¡ **: 4ê°€ì§€ ì¡°ê±´ì´ ëª¨ë‘ ì¶©ì¡±ë˜ì–´ Deadlock ë°œìƒì´ **í•„ì—°ì **.

---

## ì˜í–¥ë„ ë¶„ì„

| í•­ëª© | ì˜í–¥ | ì„¤ëª… |
|------|------|------|
| ì‚¬ìš©ì ê²½í—˜ | ğŸ”´ High | íŠ¸ëœì­ì…˜ ë¡¤ë°±ìœ¼ë¡œ ìš”ì²­ ì‹¤íŒ¨ |
| ë°ì´í„° ë¬´ê²°ì„± | ğŸŸ¢ Low | InnoDB ë¡¤ë°±ìœ¼ë¡œ ì¼ê´€ì„± ìœ ì§€ |
| ì‹œìŠ¤í…œ ì•ˆì •ì„± | ğŸŸ¡ Medium | ë°˜ë³µì  Deadlock ì‹œ ì„±ëŠ¥ ì €í•˜ |

---

## í•´ê²° ë°©ì•ˆ

### ë‹¨ê¸° (Hotfix)
```java
// íŠ¸ëœì­ì…˜ ì¬ì‹œë„ ë¡œì§ ì¶”ê°€
@Retryable(value = DeadlockLoserDataAccessException.class, maxAttempts = 3)
@Transactional
public void updateCrossTable(...) {
    // ê¸°ì¡´ ë¡œì§
}
```

### ì¥ê¸° (ê·¼ë³¸ í•´ê²°)
```java
// Lock Ordering ì ìš© - ì•ŒíŒŒë²³ìˆœ í…Œì´ë¸” ì ‘ê·¼
@Transactional
public void updateWithLockOrdering(Long userId, Long equipmentId) {
    // ì•ŒíŒŒë²³ìˆœ: equipment â†’ user
    equipmentRepository.findByIdWithLock(equipmentId);
    userRepository.findByIdWithLock(userId);
}
```

---

## ìƒì„±ëœ ì´ìŠˆ

- **Priority**: P0 (Critical)
- **Title**: [P0][Nightmare-02] Lock Ordering ë¯¸ì ìš©ìœ¼ë¡œ ì¸í•œ Deadlock ë°œìƒ

---

*Generated by 5-Agent Council - Nightmare Chaos Test*
