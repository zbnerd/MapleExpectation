# Nightmare 12: Phantom Context (Async Context Loss)

> **ë‹´ë‹¹ ì—ì´ì „íŠ¸**: ğŸ”´ Red (ì¥ì• ì£¼ì…) & ğŸŸ£ Purple (ê°ì‚¬)
> **ë‚œì´ë„**: P1 (High)
> **ì˜ˆìƒ ê²°ê³¼**: PASS (TaskDecorator ì ìš©ë¨)

---

## 0. ìµœì‹  í…ŒìŠ¤íŠ¸ ê²°ê³¼ (2025-01-20)

### âœ… PASS
- alertTaskExecutorì—ì„œ MDC ì»¨í…ìŠ¤íŠ¸ ì „íŒŒ: **PASS**
- expectationComputeExecutorì—ì„œ MDC ì»¨í…ìŠ¤íŠ¸ ì „íŒŒ: **PASS**
- 100íšŒ ë¹„ë™ê¸° í˜¸ì¶œ ì‹œ MDC ì „íŒŒ ì„±ê³µë¥ : **100%**
- [ëŒ€ì¡°êµ°] TaskDecorator ì—†ëŠ” ExecutorService: **MDC ì†ì‹¤ (ì˜ˆìƒëŒ€ë¡œ)**
- Executor ìŠ¤ë ˆë“œ ì´ë¦„ íŒ¨í„´: **PASS** (`alert-`, `expectation-`)

### âš ï¸ KNOWN LIMITATION
- CompletableFuture ì²´ì¸ (`thenRunAsync`) MDC ì „íŒŒ: **Stage 2,3 ì†ì‹¤**
  - ì´ìœ : `thenRunAsync()`ëŠ” ì´ì „ ë‹¨ê³„ ì™„ë£Œ ìŠ¤ë ˆë“œì—ì„œ ë‹¤ìŒ ì‘ì—…ì„ ì œì¶œ
  - TaskDecoratorëŠ” ì œì¶œ ì‹œì ì˜ MDCë¥¼ ìº¡ì²˜í•˜ì§€ë§Œ, ì™„ë£Œ ìŠ¤ë ˆë“œì˜ MDCëŠ” ì´ë¯¸ clearë¨
  - **í•´ê²°ì±…**: ë…ë¦½ì ì¸ `runAsync()` ì‚¬ìš© ë˜ëŠ” Micrometer Context Propagation ë„ì…

---

## 1. í…ŒìŠ¤íŠ¸ ì „ëµ (ğŸŸ¡ Yellow's Plan)

### ëª©ì 
@Async ë©”ì„œë“œ í˜¸ì¶œ ì‹œ MDC(Mapped Diagnostic Context)ì™€ SecurityContextê°€
ìƒˆ ìŠ¤ë ˆë“œë¡œ ì „íŒŒë˜ì§€ ì•Šì•„ ì¶”ì ì„±ì´ ìƒì‹¤ë˜ëŠ” ë¬¸ì œë¥¼ ê²€ì¦í•œë‹¤.

### ê²€ì¦ í¬ì¸íŠ¸
- [x] í”„ë¡œì íŠ¸ì˜ ì‹¤ì œ Executor (alertTaskExecutor, expectationComputeExecutor) MDC ì „íŒŒ
- [x] TaskDecorator ì ìš©ìœ¼ë¡œ MDC ìë™ ì „íŒŒ í™•ì¸
- [x] 100íšŒ ë°˜ë³µ í…ŒìŠ¤íŠ¸ë¡œ 100% ì „íŒŒìœ¨ í™•ì¸
- [x] CompletableFuture ì²´ì¸ì—ì„œ ì»¨í…ìŠ¤íŠ¸ ì „íŒŒ í•œê³„ í™•ì¸

### ì„±ê³µ ê¸°ì¤€
- ë¹„ë™ê¸° ìŠ¤ë ˆë“œì—ì„œë„ MDC ì»¨í…ìŠ¤íŠ¸ ìœ ì§€

---

## 2. ë¬¸ì œ ìƒí™© (ğŸ”´ Red's Analysis)

### MDC ìœ ì‹¤ ì‹œë‚˜ë¦¬ì˜¤
```java
@Service
public class OrderService {
    public void processOrder(String orderId) {
        MDC.put("orderId", orderId);  // ë©”ì¸ ìŠ¤ë ˆë“œì— ì„¤ì •

        asyncExecutor.execute(() -> {
            String id = MDC.get("orderId");  // NULL! ë‹¤ë¥¸ ìŠ¤ë ˆë“œ
            log.info("Processing order");     // ë¡œê·¸ì— orderId ì—†ìŒ
        });
    }
}
```

### ë¬¸ì œì 
- ë¶„ì‚° ì¶”ì (Tracing) ëŠê¹€
- ê°ì‚¬ ë¡œê·¸ì— ì‚¬ìš©ì ì •ë³´ ì—†ìŒ
- ë””ë²„ê¹… ì‹œ ìš”ì²­ íë¦„ ì¶”ì  ë¶ˆê°€

---

## 3. í•´ê²° ë°©ì•ˆ

### TaskDecorator ì ìš©
```java
@Configuration
public class AsyncConfig {
    @Bean
    public ThreadPoolTaskExecutor asyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setTaskDecorator(new MdcCopyingTaskDecorator());
        return executor;
    }
}

public class MdcCopyingTaskDecorator implements TaskDecorator {
    @Override
    public Runnable decorate(Runnable runnable) {
        Map<String, String> contextMap = MDC.getCopyOfContextMap();
        return () -> {
            try {
                if (contextMap != null) {
                    MDC.setContextMap(contextMap);
                }
                runnable.run();
            } finally {
                MDC.clear();
            }
        };
    }
}
```

### Micrometer Context Propagation
```java
@Bean
public ContextPropagationExecutorService contextAwareExecutor() {
    return ContextPropagation.wrapExecutorService(
        Executors.newFixedThreadPool(10)
    );
}
```

---

## 4. ê´€ë ¨ CS ì›ë¦¬

### ThreadLocal
ìŠ¤ë ˆë“œë³„ë¡œ ê²©ë¦¬ëœ ë³€ìˆ˜ ì €ì¥ì†Œ.
ìƒˆ ìŠ¤ë ˆë“œ ìƒì„± ì‹œ ë¶€ëª¨ì˜ ThreadLocal ê°’ì´ ë³µì‚¬ë˜ì§€ ì•ŠìŒ.

### Context Propagation
ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ìš”ì²­ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì „íŒŒí•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜.
OpenTelemetry, Micrometer Tracing ë“±ì´ ì´ë¥¼ ìë™í™”.

### Structured Concurrency (Java 21+)
ê°€ìƒ ìŠ¤ë ˆë“œì™€ í•¨ê»˜ ë„ì…ëœ êµ¬ì¡°í™”ëœ ë™ì‹œì„±.
ë¶€ëª¨ ìŠ¤ë ˆë“œì˜ ì»¨í…ìŠ¤íŠ¸ê°€ ìì‹ì—ê²Œ ìë™ ì „íŒŒë¨.

---

## 5. ì´ìŠˆ ì •ì˜ (ì‹¤íŒ¨ ì‹œ)

### ğŸ“Œ ë¬¸ì œ ì •ì˜
ë¹„ë™ê¸° ê²½ê³„ì—ì„œ MDC ì»¨í…ìŠ¤íŠ¸ ì†ì‹¤ë¡œ ì¶”ì ì„± ìƒì‹¤.

### âœ… Action Items
- [ ] ëª¨ë“  ThreadPoolTaskExecutorì— TaskDecorator ì ìš©
- [ ] CompletableFuture ì‚¬ìš© ì‹œ ì»¨í…ìŠ¤íŠ¸ ì „íŒŒ ê²€í† 
- [ ] ë¶„ì‚° ì¶”ì  ë¼ì´ë¸ŒëŸ¬ë¦¬(Micrometer Tracing) ë„ì… ê²€í† 

---

## 6. ìµœì¢… íŒì • (ğŸŸ¡ Yellow's Verdict)

### ê²°ê³¼: **CONDITIONAL PASS**

TaskDecoratorë¥¼ í†µí•œ MDC ì „íŒŒëŠ” **100% ì„±ê³µ**í•˜ë‚˜,
CompletableFuture ì²´ì¸(`thenRunAsync`)ì—ì„œ **Stage 2,3 MDC ì†ì‹¤** ë°œìƒ.

### ê¸°ìˆ ì  ì¸ì‚¬ì´íŠ¸
- **TaskDecorator ì •ìƒ ë™ì‘**: alertTaskExecutor, expectationComputeExecutor ëª¨ë‘ MDC ì „íŒŒ ì„±ê³µ
- **100íšŒ ë°˜ë³µ í…ŒìŠ¤íŠ¸ í†µê³¼**: ë‹¨ìˆœ ë¹„ë™ê¸° í˜¸ì¶œ ì‹œ MDC ì „íŒŒ 100%
- **CompletableFuture í•œê³„**: `thenRunAsync()`ëŠ” ì´ì „ ë‹¨ê³„ ì™„ë£Œ ìŠ¤ë ˆë“œì—ì„œ ì œì¶œí•˜ì—¬ MDC ì†ì‹¤
- **Known Limitation**: ì´ëŠ” TaskDecoratorì˜ ì„¤ê³„ í•œê³„ë¡œ, ì˜ë„ëœ ë™ì‘ì„

### ê¶Œì¥ ìœ ì§€/ê°œì„  ì‚¬í•­
1. **TaskDecorator ìœ ì§€**: í˜„ì¬ MdcCopyingTaskDecorator ì •ìƒ ë™ì‘
2. **CompletableFuture ì‚¬ìš© ì£¼ì˜**: ì²´ì¸ ì‚¬ìš© ì‹œ ë…ë¦½ì ì¸ `runAsync()` ê¶Œì¥
3. **Micrometer Context Propagation ê²€í† **: ì²´ì¸ ì»¨í…ìŠ¤íŠ¸ ì „íŒŒê°€ í•„ìš”í•œ ê²½ìš° ë„ì…
4. **ìŠ¤ë ˆë“œ ì´ë¦„ íŒ¨í„´ í™•ì¸**: `alert-`, `expectation-` í”„ë¦¬í”½ìŠ¤ë¡œ ë””ë²„ê¹… ìš©ì´

---

*Generated by 5-Agent Council*
