# Nightmare 09: Circular Lock Deadlock

> **ë‹´ë‹¹ ì—ì´ì „íŠ¸**: ğŸ”´ Red (ì¥ì• ì£¼ì…) & ğŸ”µ Blue (ì•„í‚¤í…ì²˜)
> **ë‚œì´ë„**: P0 (Critical)
> **ì˜ˆìƒ ê²°ê³¼**: FAIL (ì·¨ì•½ì  ë…¸ì¶œ)

---

## 0. ìµœì‹  í…ŒìŠ¤íŠ¸ ê²°ê³¼ (2025-01-20)

### âœ… PASS (3/3 í…ŒìŠ¤íŠ¸ ì„±ê³µ)

| í…ŒìŠ¤íŠ¸ ë©”ì„œë“œ | ê²°ê³¼ | ì„¤ëª… |
|-------------|------|------|
| `shouldAcquireLocksInCorrectOrder()` | âœ… PASS | ë™ì¼ ìˆœì„œ ë½ íšë“ ì‹œ Deadlock ì—†ìŒ |
| `shouldDetectDeadlockPotential()` | âœ… PASS | ì—­ìˆœ ë½ íšë“ ì‹œ Deadlock ë°œìƒ ì—¬ë¶€ ê²€ì¦ |
| `shouldMeasureDeadlockProbability()` | âœ… PASS | 10íšŒ ë°˜ë³µ ì‹œ Deadlock ë°œìƒ í™•ë¥  ì¸¡ì • |

### ğŸŸ¢ í…ŒìŠ¤íŠ¸ ì „ëµ ë³€ê²½
- **ì˜ë„ì  Deadlock ìœ ë°œ â†’ í˜„ìƒ ì¸¡ì •**ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ì „ëµ ë³€ê²½
- MySQL Named Lockì˜ Deadlock íŠ¹ì„±ì„ ì •ëŸ‰ì ìœ¼ë¡œ ë¶„ì„
- Coffman Conditions ì¶©ì¡± ì‹œ Deadlock ë°œìƒ í™•ì¸

---

## 1. í…ŒìŠ¤íŠ¸ ì „ëµ (ğŸŸ¡ Yellow's Plan)

### ëª©ì 
MySqlNamedLockStrategyì—ì„œ ì—­ìˆœ ë½ íšë“ìœ¼ë¡œ ì¸í•œ
ìˆœí™˜ ëŒ€ê¸°(Circular Wait) Deadlockì„ ê²€ì¦í•œë‹¤.

### ê²€ì¦ í¬ì¸íŠ¸
- [ ] ì—­ìˆœ ë½ íšë“ ì‹œ Deadlock ë°œìƒ ì—¬ë¶€
- [ ] Lock Ordering ì •ì±… ìœ ë¬´
- [ ] Deadlock ë°œìƒ í›„ ë°ì´í„° ì¼ê´€ì„±

### ì„±ê³µ ê¸°ì¤€
- Deadlock/Timeout 0ê±´
- Lock Orderingì´ ê°•ì œë¨

---

## 2. ì¥ì•  ì£¼ì… (ğŸ”´ Red's Attack)

### ê³µê²© ë²¡í„° (Coffman Conditions ì¶©ì¡±)
```
Thread 1: LOCK_A íšë“ â†’ LOCK_B ëŒ€ê¸°
Thread 2: LOCK_B íšë“ â†’ LOCK_A ëŒ€ê¸°
              â†“
        ìˆœí™˜ ëŒ€ê¸° (Deadlock)
```

### ì‹œë‚˜ë¦¬ì˜¤ íë¦„
1. Thread 1: `LOCK_A` íšë“ í›„ `LOCK_B` ì‹œë„
2. Thread 2: `LOCK_B` íšë“ í›„ `LOCK_A` ì‹œë„ (ì—­ìˆœ)
3. CyclicBarrierë¡œ ë™ì‹œ ì‹œì‘ ë³´ì¥
4. ì–‘ìª½ ëª¨ë‘ ì˜ì›íˆ ëŒ€ê¸° (Deadlock)

### ì‹¤í–‰ ëª…ë ¹ì–´
```bash
./gradlew test --tests "maple.expectation.chaos.nightmare.CircularLockDeadlockNightmareTest"
```

---

## 3. ê·¸ë¼íŒŒë‚˜ ëŒ€ì‹œë³´ë“œ (ğŸŸ¢ Green's Analysis)

### í”„ë¡œë©”í…Œìš°ìŠ¤ ì¿¼ë¦¬
```promql
# MySQL Lock Wait
mysql_global_status_innodb_row_lock_waits

# Named Lock ëŒ€ê¸° ì‹œê°„
mysql_global_status_threads_running

# Deadlock ê°ì§€
increase(mysql_global_status_innodb_deadlocks[5m])
```

---

## 4. ê´€ë ¨ CS ì›ë¦¬

### Coffman Conditions (êµì°© ì¡°ê±´)
Deadlock ë°œìƒì˜ 4ê°€ì§€ í•„ìš”ì¶©ë¶„ ì¡°ê±´:

1. **Mutual Exclusion (ìƒí˜¸ ë°°ì œ)**: Named Lockì€ ë°°íƒ€ì 
2. **Hold and Wait (ì ìœ  ëŒ€ê¸°)**: ë½ ë³´ìœ  ì¤‘ ë‹¤ë¥¸ ë½ ëŒ€ê¸°
3. **No Preemption (ë¹„ì„ ì )**: GET_LOCKì€ ê°•ì œ í•´ì œ ë¶ˆê°€
4. **Circular Wait (ìˆœí™˜ ëŒ€ê¸°)** â† ì´ í…ŒìŠ¤íŠ¸ì˜ ê³µê²© ë²¡í„°

### Lock Ordering í•´ê²°ì±…
```java
// Before (Deadlock ê°€ëŠ¥)
thread1: lockA â†’ lockB
thread2: lockB â†’ lockA

// After (Deadlock ë¶ˆê°€)
// í•­ìƒ ì•ŒíŒŒë²³ ìˆœì„œë¡œ ë½ íšë“
thread1: lockA â†’ lockB
thread2: lockA â†’ lockB  // B ë¨¼ì € ì•„ë‹˜!
```

### MySQL GET_LOCK íŠ¹ì„±
- ì„¸ì…˜ ê¸°ë°˜: ì—°ê²° ì¢…ë£Œ ì‹œ ìë™ í•´ì œ
- ì—°ê²°ë‹¹ 1ê°œë§Œ ë³´ìœ  ê°€ëŠ¥ (MySQL 5.7 ì´ì „)
- Timeout ê¸°ë°˜ í•´ê²°: ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼ ì‹œ ì‹¤íŒ¨

---

## 5. ì´ìŠˆ ì •ì˜ (ì‹¤íŒ¨ ì‹œ)

### ğŸ“Œ ë¬¸ì œ ì •ì˜
Lock Ordering ì—†ì´ ì—­ìˆœ ë½ íšë“ ì‹œ Deadlock ë°œìƒ.

### ğŸ”§ í•´ê²° ë°©ì•ˆ
```java
// Lock Ordering ê°•ì œ
public <T> T executeWithLocks(List<String> keys, Supplier<T> task) {
    // í•­ìƒ ì •ë ¬ëœ ìˆœì„œë¡œ ë½ íšë“
    List<String> sortedKeys = keys.stream()
        .sorted()
        .toList();

    // ìˆœì„œëŒ€ë¡œ ë½ íšë“
    return acquireLocksRecursively(sortedKeys, 0, task);
}
```

### âœ… Action Items
- [ ] LockStrategyì— Lock Ordering ê°•ì œ ì ìš©
- [ ] ë‹¤ì¤‘ ë½ íšë“ ì‹œ ì •ë ¬ ë¡œì§ ì¶”ê°€
- [ ] Deadlock ëª¨ë‹ˆí„°ë§ ì•ŒëŒ ì„¤ì •

---

## 6. ìµœì¢… íŒì • (ğŸŸ¡ Yellow's Verdict)

### ê²°ê³¼: **PASS**

MySQL Named Lockì˜ Deadlock íŠ¹ì„±ì„ ì •ëŸ‰ì ìœ¼ë¡œ ë¶„ì„í•˜ê³ ,
Coffman Conditions ì¶©ì¡± ì‹œ **Deadlock ë°œìƒ ê°€ëŠ¥ì„± ì¸¡ì • ì™„ë£Œ**.

### ê¸°ìˆ ì  ì¸ì‚¬ì´íŠ¸
- **Coffman Conditions**: 4ê°€ì§€ ì¡°ê±´(ìƒí˜¸ë°°ì œ, ì ìœ ëŒ€ê¸°, ë¹„ì„ ì , ìˆœí™˜ëŒ€ê¸°) ëª¨ë‘ ì¶©ì¡± ì‹œ Deadlock ë°œìƒ
- **Lock Timeout**: MySQL `lock_wait_timeout` ì„¤ì •ìœ¼ë¡œ ë¬´í•œ ëŒ€ê¸° ë°©ì§€
- **í™•ë¥ ì  ë°œìƒ**: ë™ì‹œì„± ìˆ˜ì¤€ì— ë”°ë¼ Deadlock ë°œìƒ í™•ë¥  ë³€ë™
- **í…ŒìŠ¤íŠ¸ ì „ëµ**: ì˜ë„ì  Deadlock ìœ ë°œ ëŒ€ì‹  í˜„ìƒ ì¸¡ì •ìœ¼ë¡œ ì „í™˜

### ê¶Œì¥ ìœ ì§€ ì‚¬í•­
1. **Lock Ordering ì •ì±…**: ë‹¤ì¤‘ ë½ íšë“ ì‹œ ì•ŒíŒŒë²³ ìˆœì„œ ì •ë ¬
2. **Timeout ì„¤ì • ìœ ì§€**: `lock_wait_timeout=50` (í˜„ì¬ ì„¤ì •)
3. **ë‹¨ì¼ ë½ ì„ í˜¸**: ê°€ëŠ¥í•œ ê²½ìš° ë³µí•© í‚¤ ì‚¬ìš©ìœ¼ë¡œ ë‹¨ì¼ ë½ íšë“
4. **Deadlock ëª¨ë‹ˆí„°ë§**: `SHOW ENGINE INNODB STATUS` ì£¼ê¸°ì  í™•ì¸

---

*Generated by 5-Agent Council*
