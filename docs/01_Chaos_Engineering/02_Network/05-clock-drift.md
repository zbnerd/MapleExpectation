# Scenario 05: Clock Drift - Time Traveler (ì‹œê°„ ë¶ˆì¼ì¹˜)

> **ë‹´ë‹¹ ì—ì´ì „íŠ¸**: ğŸ”´ Red (ì¥ì• ì£¼ì…) & ğŸŸ¢ Green (ì„±ëŠ¥ê²€ì¦)
> **ë‚œì´ë„**: P1 (Important) - High
> **í…ŒìŠ¤íŠ¸ ì¼ì‹œ**: 2026-01-19

---

## 1. í…ŒìŠ¤íŠ¸ ì „ëµ (ğŸŸ¡ Yellow's Plan)

### ëª©ì 
ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ **ì„œë²„ ê°„ ì‹œê°„ ë¶ˆì¼ì¹˜(Clock Drift)**ê°€ ë°œìƒí–ˆì„ ë•Œ, TTL ê³„ì‚°, ë¶„ì‚° ë½ ë§Œë£Œ, ì´ë²¤íŠ¸ ìˆœì„œ ë“±ì´ ì •í™•í•˜ê²Œ ë™ì‘í•˜ëŠ”ì§€ ê²€ì¦í•œë‹¤.

### ê²€ì¦ í¬ì¸íŠ¸
- [x] Redis TTLì€ ì„œë²„ ì‹œê°„ ê¸°ì¤€ (í´ë¼ì´ì–¸íŠ¸ Clock Drift ë¬´ê´€)
- [x] ë¶„ì‚° ë½ ë§Œë£ŒëŠ” Monotonic Time ê¸°ì¤€
- [x] ë™ì‹œ ë½ ìš”ì²­ ì‹œ FIFO ìˆœì„œ ë³´ì¥
- [x] System.nanoTime()ì€ í•­ìƒ ë‹¨ì¡° ì¦ê°€

### ì„±ê³µ ê¸°ì¤€
- TTL ì˜¤ì°¨ Â±1ì´ˆ ì´ë‚´
- ë½ ë§Œë£Œ ì •í™•ë„ 95% ì´ìƒ
- Monotonic Clock ìœ„ë°˜ 0ê±´

---

## 2. ì¥ì•  ì£¼ì… (ğŸ”´ Red's Attack)

### Clock Drift ì‹œë‚˜ë¦¬ì˜¤
```bash
# ì‹¤ì œ ì‹œìŠ¤í…œì—ì„œ Clock Drift ì‹œë®¬ë ˆì´ì…˜ (í…ŒìŠ¤íŠ¸ìš©)
# ì£¼ì˜: í”„ë¡œë•ì…˜ì—ì„œëŠ” ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€!

# ì‹œê°„ì„ 5ë¶„ ì•ìœ¼ë¡œ (Clock Jump Forward)
sudo date -s "+5 minutes"

# ì‹œê°„ì„ 5ë¶„ ë’¤ë¡œ (Clock Jump Backward) - ë” ìœ„í—˜!
sudo date -s "-5 minutes"
```

### ê²€ì¦ ëŒ€ìƒ
| ì‹œê°„ ìœ í˜• | ì„¤ëª… | ìœ„í—˜ë„ |
|----------|------|-------|
| **Wall Clock** | `System.currentTimeMillis()` | âš ï¸ NTP ë™ê¸°í™”ë¡œ ì í”„ ê°€ëŠ¥ |
| **Monotonic Clock** | `System.nanoTime()` | âœ… í•­ìƒ ì¦ê°€ (ì•ˆì „) |
| **Redis Server Time** | Redis ë‚´ë¶€ ì‹œê³„ | âœ… í´ë¼ì´ì–¸íŠ¸ì™€ ë…ë¦½ |

---

## 3. í„°ë¯¸ë„ ëŒ€ì‹œë³´ë“œ + ê´€ë ¨ ë¡œê·¸ (ğŸŸ¢ Green's Analysis)

### í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼ ğŸ“Š

```
======================================================================
  ğŸ“Š Clock Drift Test Results
======================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TTL Accuracy Test                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Initial TTL: 10s                                                   â”‚
â”‚ After 5s wait: 5s remaining  âœ…                                    â”‚
â”‚ Drift Error: 0s (within tolerance)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Lock Expiry Test                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Lock TTL: 5s                                                       â”‚
â”‚ After 3s: ğŸ”’ LOCKED (expected)                                     â”‚
â”‚ After 6s: ğŸ”“ EXPIRED (expected)  âœ…                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Monotonic Clock Test                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Iterations: 1000                                                   â”‚
â”‚ Monotonic Violations: 0  âœ…                                        â”‚
â”‚ nanoTime always increases                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FIFO Lock Order Test                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Threads: 3                                                         â”‚
â”‚ Acquire Order: [1, 2, 3] or [2, 1, 3] (fair scheduling)  âœ…        â”‚
â”‚ All threads acquired lock successfully                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë¡œê·¸ ì¦ê±°

```text
# Test Output (ì‹œê°„ìˆœ ì •ë ¬)
[Green] Initial TTL: 10s, After 5s: 5s  <-- 1. TTL ì •í™•íˆ ê°ì†Œ
[Blue] Elapsed: 6s, Lock expired: true  <-- 2. ë½ ì •í™•íˆ ë§Œë£Œ
[Purple] Thread 1 acquired lock at 2026-01-19T19:30:00.123Z  <-- 3. ìˆœì°¨ íšë“
[Purple] Thread 2 acquired lock at 2026-01-19T19:30:00.234Z
[Purple] Thread 3 acquired lock at 2026-01-19T19:30:00.345Z
[Green] Monotonic violations: 0 / 1000  <-- 4. ë‹¨ì¡° ì¦ê°€ ë³´ì¥
```

**(ëª¨ë“  ì‹œê°„ ê¸°ë°˜ ë¡œì§ì´ Clock Driftì— ì˜í–¥ë°›ì§€ ì•ŠìŒì„ ì…ì¦)**

---

## 4. í…ŒìŠ¤íŠ¸ Quick Start

### ì‹¤í–‰ ëª…ë ¹ì–´
```bash
# Clock Drift í…ŒìŠ¤íŠ¸ ì‹¤í–‰
./gradlew test --tests "maple.expectation.chaos.network.ClockDriftChaosTest" \
  -Ptag=chaos \
  2>&1 | tee logs/clock-drift-$(date +%Y%m%d_%H%M%S).log
```

---

## 5. ë°ì´í„° íë¦„ (ğŸ”µ Blue's Blueprint)

### Wall Clock vs Monotonic Clock

```mermaid
graph LR
    subgraph "Wall Clock (ìœ„í—˜)"
        A[System.currentTimeMillis] -->|NTP Sync| B[ì‹œê°„ ì í”„ ê°€ëŠ¥]
        B --> C[TTL ì˜¤ê³„ì‚°]
        B --> D[ë½ ì¡°ê¸° ë§Œë£Œ]
    end

    subgraph "Monotonic Clock (ì•ˆì „)"
        E[System.nanoTime] --> F[í•­ìƒ ì¦ê°€]
        F --> G[ì •í™•í•œ ê²½ê³¼ì‹œê°„]
    end

    subgraph "Redis Server Time"
        H[Redis TIME] --> I[ì„œë²„ ë…ë¦½]
        I --> J[í´ë¼ì´ì–¸íŠ¸ ë¬´ê´€]
    end
```

### TTL ê³„ì‚° íë¦„

```mermaid
sequenceDiagram
    participant Client
    participant Redis
    participant Clock as Server Clock

    Client->>Redis: SETEX key 10 value
    Redis->>Clock: Get current time (T0)
    Redis->>Redis: Store expiry = T0 + 10s

    Note over Client: 5ì´ˆ í›„...

    Client->>Redis: TTL key
    Redis->>Clock: Get current time (T1)
    Redis->>Redis: remaining = expiry - T1
    Redis-->>Client: 5 (seconds)

    Note over Redis: í´ë¼ì´ì–¸íŠ¸ ì‹œê°„ê³¼ ë¬´ê´€!
```

---

## 6. ë³µêµ¬ ì‹œë‚˜ë¦¬ì˜¤

### NTP ë™ê¸°í™” ë³µêµ¬
```bash
# NTP ê°•ì œ ë™ê¸°í™”
sudo systemctl restart systemd-timesyncd
timedatectl status

# ë˜ëŠ” ntpdate ì‚¬ìš©
sudo ntpdate pool.ntp.org
```

### Clock Drift ëª¨ë‹ˆí„°ë§
```bash
# ì‹œìŠ¤í…œ ì‹œê°„ ì˜¤ì°¨ í™•ì¸
chronyc tracking

# ë˜ëŠ”
ntpq -p
```

---

## 7. ê´€ë ¨ CS ì›ë¦¬ (í•™ìŠµìš©)

### í•µì‹¬ ê°œë…

1. **Wall Clock vs Monotonic Clock**
   - **Wall Clock**: ì‹¤ì œ ì‹œê°„ (NTPë¡œ ì¡°ì • ê°€ëŠ¥, ì í”„ ê°€ëŠ¥)
   - **Monotonic Clock**: ì‹œìŠ¤í…œ ì‹œì‘ í›„ ê²½ê³¼ ì‹œê°„ (í•­ìƒ ì¦ê°€)

2. **NTP (Network Time Protocol)**
   - ì¸í„°ë„· í‘œì¤€ ì‹œê°„ ë™ê¸°í™” í”„ë¡œí† ì½œ
   - Stratum ë ˆë²¨ë¡œ ì •í™•ë„ ê³„ì¸µí™”
   - ì¼ë°˜ì ìœ¼ë¡œ ìˆ˜ ms ì´ë‚´ ì˜¤ì°¨

3. **Lamport Timestamp**
   - ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ì´ë²¤íŠ¸ ìˆœì„œ ê²°ì •
   - ë¬¼ë¦¬ì  ì‹œê°„ì´ ì•„ë‹Œ ë…¼ë¦¬ì  ì‹œê°„
   - `happens-before` ê´€ê³„ ë³´ì¥

4. **Vector Clock**
   - Lamport Timestampì˜ í™•ì¥
   - ë™ì‹œì„±(concurrency) ê°ì§€ ê°€ëŠ¥
   - ê° ë…¸ë“œë³„ ì¹´ìš´í„° ë²¡í„°

### ì½”ë“œ Best Practice

```java
// âŒ Bad: Wall Clock ì‚¬ìš© (Clock Driftì— ì·¨ì•½)
long startTime = System.currentTimeMillis();
// ... ì‘ì—… ...
long elapsed = System.currentTimeMillis() - startTime; // ìŒìˆ˜ ê°€ëŠ¥!

// âœ… Good: Monotonic Clock ì‚¬ìš©
long startNanos = System.nanoTime();
// ... ì‘ì—… ...
long elapsedNanos = System.nanoTime() - startNanos; // í•­ìƒ ì–‘ìˆ˜
```

### ì°¸ê³  ìë£Œ
- [Google Spanner - TrueTime](https://cloud.google.com/spanner/docs/true-time-external-consistency)
- [Lamport - Time, Clocks, and Ordering](https://lamport.azurewebsites.net/pubs/time-clocks.pdf)
- [Jepsen: Redis Sentinel Clock Drift](https://jepsen.io/analyses)

---

## 8. ìµœì¢… íŒì • (ğŸŸ¡ Yellow's Verdict)

### ê²°ê³¼: **PASS**

### ê¸°ìˆ ì  ì¸ì‚¬ì´íŠ¸
1. **Redis TTL**: ì„œë²„ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ Clock Driftì— ì•ˆì „
2. **Redisson Lock**: ë‚´ë¶€ì ìœ¼ë¡œ Monotonic Clock ì‚¬ìš©
3. **System.nanoTime()**: JVM ë ˆë²¨ì—ì„œ ë‹¨ì¡° ì¦ê°€ ë³´ì¥

### Best Practice ê¶Œì¥ì‚¬í•­
1. ê²½ê³¼ ì‹œê°„ ì¸¡ì • ì‹œ `System.nanoTime()` ì‚¬ìš©
2. íƒ€ì„ìŠ¤íƒ¬í”„ ë¹„êµ ì‹œ ì„œë²„ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ í†µì¼
3. ë¶„ì‚° ë½ TTLì€ ì¶©ë¶„í•œ ì—¬ìœ  ì‹œê°„ í™•ë³´ (Clock Drift ê³ ë ¤)

---

*Generated by 5-Agent Council - Chaos Testing Deep Dive*
