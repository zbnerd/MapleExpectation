package maple.expectation.chaos.network;

import static org.assertj.core.api.Assertions.assertThat;
import static org.awaitility.Awaitility.await;

import java.time.Duration;
import java.util.concurrent.*;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicReference;
import maple.expectation.support.SentinelContainerBase;
import org.junit.jupiter.api.*;
import org.redisson.api.RLock;
import org.redisson.api.RedissonClient;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;

/**
 * Scenario 04: Split Brain - ë‘ ëª…ì˜ ì™• (ë„¤íŠ¸ì›Œí¬ íŒŒí‹°ì…˜)
 *
 * <h4>5-Agent Council</h4>
 *
 * <ul>
 *   <li>ğŸ”´ Red (SRE): ì¥ì•  ì£¼ì… - ë„¤íŠ¸ì›Œí¬ íŒŒí‹°ì…˜ìœ¼ë¡œ Master ê²©ë¦¬
 *   <li>ğŸŸ£ Purple (Auditor): ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ - ì¤‘ë³µ ì“°ê¸° ê°ì§€
 *   <li>ğŸ”µ Blue (Architect): íë¦„ ê²€ì¦ - Sentinel Quorum ë™ì‘
 *   <li>ğŸŸ¢ Green (Performance): ë©”íŠ¸ë¦­ ê²€ì¦ - Failover ì‹œê°„
 *   <li>ğŸŸ¡ Yellow (QA Master): í…ŒìŠ¤íŠ¸ ì „ëµ - Stale Read ê²€ì¦
 * </ul>
 *
 * <h4>ê²€ì¦ í¬ì¸íŠ¸</h4>
 *
 * <ol>
 *   <li>ë„¤íŠ¸ì›Œí¬ íŒŒí‹°ì…˜ ì‹œ Sentinel Quorum(2/3)ìœ¼ë¡œ ìƒˆ Master ì„ ì¶œ
 *   <li>êµ¬ Masterê°€ ê²©ë¦¬ë˜ì–´ë„ ì ì‹œ ì“°ê¸° ê°€ëŠ¥ (ìœ„í—˜!)
 *   <li>ë³µêµ¬ í›„ ë°ì´í„° ì¶©ëŒ ê°€ëŠ¥ì„± ê²€ì¦
 *   <li>ë¶„ì‚° ë½ì˜ ì•ˆì „ì„± ê²€ì¦ (Redlock ì›ë¦¬)
 * </ol>
 *
 * <h4>CS ì›ë¦¬</h4>
 *
 * <ul>
 *   <li>CAP ì •ë¦¬: ë„¤íŠ¸ì›Œí¬ íŒŒí‹°ì…˜ ì‹œ C(ì¼ê´€ì„±) vs A(ê°€ìš©ì„±) ì„ íƒ
 *   <li>Quorum: ê³¼ë°˜ìˆ˜ ë™ì˜ë¡œ ì˜ì‚¬ê²°ì • (Byzantine Fault Tolerance)
 *   <li>Fencing Token: êµ¬ Masterì˜ stale write ë°©ì§€
 * </ul>
 *
 * @see maple.expectation.support.SentinelContainerBase
 */
@Tag("chaos")
@Tag("sentinel")
@DisplayName("Scenario 04: Split Brain - ë„¤íŠ¸ì›Œí¬ íŒŒí‹°ì…˜ ë° ë°ì´í„° ì •í•©ì„± ê²€ì¦")
class SplitBrainChaosTest extends SentinelContainerBase {

  @Autowired private RedisTemplate<String, String> redisTemplate;

  @Autowired private RedissonClient redissonClient;

  private static final String SPLIT_BRAIN_KEY = "split-brain:test";

  @BeforeEach
  void setUp() {
    // í…ŒìŠ¤íŠ¸ ì „ í‚¤ ì´ˆê¸°í™”
    try {
      redisTemplate.delete(SPLIT_BRAIN_KEY);
    } catch (Exception ignored) {
    }
  }

  /**
   * ğŸŸ¡ Yellow's Test 1: Master ê²©ë¦¬ ì‹œ Sentinel Quorumìœ¼ë¡œ ìƒˆ Master ì„ ì¶œ
   *
   * <p><b>ì‹œë‚˜ë¦¬ì˜¤</b>:
   *
   * <ol>
   *   <li>Masterì— ì´ˆê¸° ë°ì´í„° ì“°ê¸°
   *   <li>Masterë¥¼ ë„¤íŠ¸ì›Œí¬ì—ì„œ ê²©ë¦¬ (Toxiproxy)
   *   <li>Sentinel Quorum(2/3)ì´ ìƒˆ Master ì„ ì¶œ
   *   <li>ìƒˆ Masterì—ì„œ ë°ì´í„° ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
   * </ol>
   *
   * <p><b>ì˜ˆìƒ ë™ì‘</b>: Failover í›„ì—ë„ ì„œë¹„ìŠ¤ ê°€ìš©ì„± ìœ ì§€
   */
  @Test
  @DisplayName("Master ê²©ë¦¬ â†’ Sentinel Quorumìœ¼ë¡œ ìƒˆ Master ì„ ì¶œ")
  void shouldElectNewMaster_whenOriginalMasterIsolated() {
    // Given: ì´ˆê¸° ë°ì´í„° ì“°ê¸°
    redisTemplate.opsForValue().set(SPLIT_BRAIN_KEY, "initial-value");
    String initialValue = redisTemplate.opsForValue().get(SPLIT_BRAIN_KEY);
    assertThat(initialValue).isEqualTo("initial-value");

    // When: Master ê²©ë¦¬ (ë„¤íŠ¸ì›Œí¬ íŒŒí‹°ì…˜)
    long failoverStart = System.currentTimeMillis();
    failMaster();

    // Then: Sentinelì´ ìƒˆ Master ì„ ì¶œ â†’ ì„œë¹„ìŠ¤ ë³µêµ¬
    await()
        .atMost(Duration.ofSeconds(5))
        .pollInterval(Duration.ofMillis(200))
        .untilAsserted(
            () -> {
              String value = redisTemplate.opsForValue().get(SPLIT_BRAIN_KEY);
              assertThat(value).as("Failover í›„ ìƒˆ Masterì—ì„œ ë°ì´í„° ì¡°íšŒ ê°€ëŠ¥").isEqualTo("initial-value");
            });

    long failoverTime = System.currentTimeMillis() - failoverStart;
    System.out.printf("[Green] Failover ì™„ë£Œ ì‹œê°„: %dms%n", failoverTime);

    // ìƒˆ Masterì— ì“°ê¸° ê°€ëŠ¥
    redisTemplate.opsForValue().set(SPLIT_BRAIN_KEY, "new-master-value");
    String newValue = redisTemplate.opsForValue().get(SPLIT_BRAIN_KEY);
    assertThat(newValue).isEqualTo("new-master-value");
  }

  /**
   * ğŸŸ£ Purple's Test 2: Split Brain ì¤‘ ë°ì´í„° ì¶©ëŒ ê°€ëŠ¥ì„± ê²€ì¦
   *
   * <p><b>ì‹œë‚˜ë¦¬ì˜¤</b>:
   *
   * <ol>
   *   <li>ë™ì‹œì— ë‘ í´ë¼ì´ì–¸íŠ¸ê°€ ë‹¤ë¥¸ ê°’ì„ ì“°ëŠ” ìƒí™© ì‹œë®¬ë ˆì´ì…˜
   *   <li>ê²©ë¦¬ëœ êµ¬ MasterëŠ” ì ì‹œ ì“°ê¸°ë¥¼ ìˆ˜ë½í•  ìˆ˜ ìˆìŒ (ìœ„í—˜!)
   *   <li>ë³µêµ¬ í›„ ì–´ë–¤ ê°’ì´ ë‚¨ëŠ”ì§€ í™•ì¸
   * </ol>
   *
   * <p><b>ì˜ˆìƒ ë™ì‘</b>: "Last Writer Wins" - ë§ˆì§€ë§‰ ì“°ê¸°ê°€ ìŠ¹ë¦¬
   */
  @Test
  @DisplayName("Split Brain ì¤‘ ë™ì‹œ ì“°ê¸° â†’ Last Writer Wins ê²€ì¦")
  void shouldLastWriterWin_whenConcurrentWritesDuringSplitBrain() throws Exception {
    // Given: ì´ˆê¸° ë°ì´í„°
    redisTemplate.opsForValue().set(SPLIT_BRAIN_KEY, "original");

    CountDownLatch writeLatch = new CountDownLatch(2);
    AtomicReference<String> writer1Result = new AtomicReference<>();
    AtomicReference<String> writer2Result = new AtomicReference<>();

    ExecutorService executor = Executors.newFixedThreadPool(2);

    try {
      // When: ë³‘ë ¬ ì“°ê¸° ì‹œë„
      executor.submit(
          () -> {
            try {
              redisTemplate.opsForValue().set(SPLIT_BRAIN_KEY, "writer-1");
              writer1Result.set("success");
            } catch (Exception e) {
              writer1Result.set("failed: " + e.getMessage());
            }
            writeLatch.countDown();
          });

      executor.submit(
          () -> {
            try {
              Thread.sleep(50); // ì•½ê°„ì˜ ì§€ì—°
              redisTemplate.opsForValue().set(SPLIT_BRAIN_KEY, "writer-2");
              writer2Result.set("success");
            } catch (Exception e) {
              writer2Result.set("failed: " + e.getMessage());
            }
            writeLatch.countDown();
          });

      writeLatch.await(5, TimeUnit.SECONDS);

      // Then: ë§ˆì§€ë§‰ ì“°ê¸°ê°€ ìŠ¹ë¦¬
      String finalValue = redisTemplate.opsForValue().get(SPLIT_BRAIN_KEY);
      System.out.printf(
          "[Purple] Writer1: %s, Writer2: %s, Final: %s%n",
          writer1Result.get(), writer2Result.get(), finalValue);

      // ë‘˜ ì¤‘ í•˜ë‚˜ì˜ ê°’ì´ì–´ì•¼ í•¨
      assertThat(finalValue).as("ë™ì‹œ ì“°ê¸° í›„ ë§ˆì§€ë§‰ ê°’ì´ ìœ ì§€").isIn("writer-1", "writer-2");

    } finally {
      executor.shutdown();
      executor.awaitTermination(5, TimeUnit.SECONDS);
    }
  }

  /**
   * ğŸ”µ Blue's Test 3: ë¶„ì‚° ë½ìœ¼ë¡œ Split Brain ë°©ì§€
   *
   * <p><b>ì‹œë‚˜ë¦¬ì˜¤</b>:
   *
   * <ol>
   *   <li>ë¶„ì‚° ë½ íšë“
   *   <li>Master ê²©ë¦¬
   *   <li>Failover í›„ ë½ ìƒíƒœ í™•ì¸
   *   <li>ìƒˆ ë½ íšë“ ì‹œë„
   * </ol>
   *
   * <p><b>ì˜ˆìƒ ë™ì‘</b>: Redissonì˜ Watch Dogì´ ë½ ê°±ì‹  ì‹¤íŒ¨ â†’ ë½ í•´ì œ
   */
  @Test
  @DisplayName("ë¶„ì‚° ë½ ë³´ìœ  ì¤‘ Master ê²©ë¦¬ â†’ Failover í›„ ë½ ì•ˆì „ì„±")
  void shouldMaintainLockSafety_whenMasterIsolatedDuringLock() throws Exception {
    // Given: ë¶„ì‚° ë½ íšë“
    RLock lock = redissonClient.getLock("split-brain:lock");
    boolean locked = lock.tryLock(2, 30, TimeUnit.SECONDS);
    assertThat(locked).as("ì´ˆê¸° ë½ íšë“ ì„±ê³µ").isTrue();

    // When: Master ê²©ë¦¬
    failMaster();

    // Then: Failover ëŒ€ê¸°
    await()
        .atMost(Duration.ofSeconds(5))
        .pollInterval(Duration.ofMillis(200))
        .until(
            () -> {
              try {
                return "PONG".equals(redisTemplate.getConnectionFactory().getConnection().ping());
              } catch (Exception e) {
                return false;
              }
            });

    // ë½ ìƒíƒœ í™•ì¸ (Redissonì´ ìë™ ì¬ì—°ê²°)
    await()
        .atMost(Duration.ofSeconds(3))
        .pollInterval(Duration.ofMillis(200))
        .untilAsserted(
            () -> {
              boolean stillLocked = lock.isLocked();
              System.out.printf(
                  "[Blue] Failover í›„ ë½ ìƒíƒœ: %s%n", stillLocked ? "LOCKED" : "UNLOCKED");
              // ë½ì´ ìœ ì§€ë˜ê±°ë‚˜ í•´ì œë˜ì—ˆë“  ì—ëŸ¬ ì—†ì´ í™•ì¸ ê°€ëŠ¥í•´ì•¼ í•¨
              assertThat(stillLocked).isNotNull();
            });

    // ì•ˆì „í•˜ê²Œ ë½ í•´ì œ
    if (lock.isHeldByCurrentThread()) {
      lock.unlock();
    }

    // ìƒˆ ë½ íšë“ ê°€ëŠ¥ í™•ì¸
    RLock newLock = redissonClient.getLock("split-brain:new-lock");
    boolean newLocked = newLock.tryLock(2, 10, TimeUnit.SECONDS);
    assertThat(newLocked).as("Failover í›„ ìƒˆ ë½ íšë“ ê°€ëŠ¥").isTrue();
    newLock.unlock();
  }

  /**
   * ğŸŸ¢ Green's Test 4: Stale Read ê²€ì¦ - êµ¬ Masterì˜ ì˜¤ë˜ëœ ë°ì´í„°
   *
   * <p><b>ì‹œë‚˜ë¦¬ì˜¤</b>:
   *
   * <ol>
   *   <li>Masterì— ê°’ ì“°ê¸°
   *   <li>Master ê²©ë¦¬ â†’ Slaveê°€ Masterë¡œ ìŠ¹ê²©
   *   <li>ìƒˆ Masterì— ë‹¤ë¥¸ ê°’ ì“°ê¸°
   *   <li>êµ¬ Master ë³µêµ¬ â†’ Slaveë¡œ ê°•ë“±
   *   <li>ìµœì¢… ê°’ í™•ì¸ (ìƒˆ Master ê°’ì´ì–´ì•¼ í•¨)
   * </ol>
   */
  @Test
  @DisplayName("êµ¬ Master ë³µêµ¬ â†’ Slave ê°•ë“± í›„ ë°ì´í„° ë™ê¸°í™”")
  void shouldSyncData_whenOldMasterRejoinsAsReplica() {
    // Given: ì´ˆê¸° ë°ì´í„°
    redisTemplate.opsForValue().set(SPLIT_BRAIN_KEY, "before-partition");

    // When: Master ê²©ë¦¬ â†’ Failover
    failMaster();

    // Failover ì™„ë£Œ ëŒ€ê¸°
    await()
        .atMost(Duration.ofSeconds(5))
        .pollInterval(Duration.ofMillis(200))
        .until(
            () -> {
              try {
                return redisTemplate.opsForValue().get(SPLIT_BRAIN_KEY) != null;
              } catch (Exception e) {
                return false;
              }
            });

    // ìƒˆ Masterì— ì“°ê¸°
    redisTemplate.opsForValue().set(SPLIT_BRAIN_KEY, "after-failover");

    // êµ¬ Master ë³µêµ¬
    recoverMaster();

    // Then: ë³µêµ¬ í›„ ìƒˆ Masterì˜ ê°’ì´ ìœ ì§€ë˜ì–´ì•¼ í•¨
    await()
        .atMost(Duration.ofSeconds(5))
        .pollInterval(Duration.ofMillis(200))
        .untilAsserted(
            () -> {
              String value = redisTemplate.opsForValue().get(SPLIT_BRAIN_KEY);
              System.out.printf("[Green] ë³µêµ¬ í›„ ìµœì¢… ê°’: %s%n", value);
              assertThat(value).as("ë³µêµ¬ í›„ ìƒˆ Masterì˜ ê°’ì´ ìœ ì§€ë˜ì–´ì•¼ í•¨").isEqualTo("after-failover");
            });
  }

  /**
   * ğŸ”´ Red's Test 5: ë°˜ë³µ ì¥ì•  ì£¼ì… â†’ ì‹œìŠ¤í…œ ì•ˆì •ì„±
   *
   * <p><b>ì‹œë‚˜ë¦¬ì˜¤</b>:
   *
   * <ol>
   *   <li>3íšŒ ì—°ì† ì¥ì•  ì£¼ì…/ë³µêµ¬ ì‚¬ì´í´
   *   <li>ë§¤ ì‚¬ì´í´ë§ˆë‹¤ ë°ì´í„° ì“°ê¸°/ì½ê¸°
   *   <li>ìµœì¢… ë°ì´í„° ì •í•©ì„± í™•ì¸
   * </ol>
   */
  @Test
  @DisplayName("ë°˜ë³µ ì¥ì•  ì£¼ì…/ë³µêµ¬ ì‚¬ì´í´ í›„ ì‹œìŠ¤í…œ ì•ˆì •ì„±")
  void shouldRemainStable_afterRepeatedFailoverCycles() {
    AtomicInteger writeCount = new AtomicInteger(0);

    for (int cycle = 1; cycle <= 3; cycle++) {
      final int currentCycle = cycle;

      // ë°ì´í„° ì“°ê¸°
      String value = "cycle-" + cycle;
      await()
          .atMost(Duration.ofSeconds(5))
          .pollInterval(Duration.ofMillis(200))
          .untilAsserted(
              () -> {
                redisTemplate.opsForValue().set(SPLIT_BRAIN_KEY, value);
                writeCount.incrementAndGet();
              });

      // ì¥ì•  ì£¼ì…
      failMaster();

      // Failover ëŒ€ê¸°
      await()
          .atMost(Duration.ofSeconds(5))
          .pollInterval(Duration.ofMillis(200))
          .until(
              () -> {
                try {
                  return "PONG".equals(redisTemplate.getConnectionFactory().getConnection().ping());
                } catch (Exception e) {
                  return false;
                }
              });

      // ë°ì´í„° í™•ì¸
      await()
          .atMost(Duration.ofSeconds(3))
          .untilAsserted(
              () -> {
                String readValue = redisTemplate.opsForValue().get(SPLIT_BRAIN_KEY);
                System.out.printf(
                    "[Red] Cycle %d: ì“´ ê°’=%s, ì½ì€ ê°’=%s%n", currentCycle, value, readValue);
                assertThat(readValue).isEqualTo(value);
              });

      // ë³µêµ¬
      recoverMaster();

      // ì•ˆì •í™” ëŒ€ê¸°
      await()
          .atMost(Duration.ofSeconds(3))
          .pollInterval(Duration.ofMillis(200))
          .until(
              () -> {
                try {
                  return "PONG".equals(redisTemplate.getConnectionFactory().getConnection().ping());
                } catch (Exception e) {
                  return false;
                }
              });
    }

    // ìµœì¢… ê²€ì¦
    assertThat(writeCount.get()).as("3íšŒ ì‚¬ì´í´ ëª¨ë‘ ì“°ê¸° ì„±ê³µ").isGreaterThanOrEqualTo(3);
  }
}
