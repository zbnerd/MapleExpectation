spring:
  application:
    name: maple-expectation
  profiles:
    active: local # [Safety Guard] ë³„ë„ ì„¤ì • ì—†ìœ¼ë©´ ë¬´ì¡°ê±´ ë¡œì»¬ ëª¨ë“œ
  lifecycle:
    timeout-per-shutdown-phase: 30s

  # ê³µí†µ ë“œë¼ì´ë²„ ì„¤ì •
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      register-mbeans: true # JMXë¥¼ í†µí•´ ì§€í‘œ ë…¸ì¶œ í™œì„±í™”

  # ê³µí†µ JPA ì„¤ì •
  jpa:
    properties:
      hibernate:
        jdbc:
          batch_size: 1000
        format_sql: false
        show_sql: false

# ğŸ“Š [PR #1, #3] ê´€ì¸¡ ê°€ëŠ¥ì„±(Observability) ì„¤ì •
management:
  endpoints:
    web:
      exposure:
        include: "health,info,metrics,prometheus"
  endpoint:
    health:
      show-details: always # ì„œí‚· ë¸Œë ˆì´ì»¤ ìƒíƒœë¥¼ ìƒì„¸íˆ ë³´ê¸° ìœ„í•´ í•„ìˆ˜
  health:
    circuitbreakers:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name} # ëª¨ë“  ë©”íŠ¸ë¦­ì— ì•± ì´ë¦„ íƒœê·¸ ë¶€ì—¬

# ğŸ›¡ï¸ [PR #2] íšŒë³µ íƒ„ë ¥ì„±(Resilience4j) ì„¤ì •
resilience4j:
  circuitbreaker:
    circuit-breaker-aspect-order: 400
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowSize: 10              # ìµœê·¼ 10ë²ˆì˜ í˜¸ì¶œ ê¸°ì¤€
        failureRateThreshold: 50           # ì‹¤íŒ¨ìœ¨ 50% ì´ìƒ ì‹œ Open
        waitDurationInOpenState: 10s       # Open ìœ ì§€ ì‹œê°„
        permittedNumberOfCallsInHalfOpenState: 3
        ignoreExceptions:
          # ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸(404 ë“±)ëŠ” ì‹¤íŒ¨ë¡œ ì¹´ìš´íŠ¸í•˜ì§€ ì•ŠìŒ
          - maple.expectation.global.error.exception.marker.CircuitBreakerIgnoreMarker
        recordExceptions:
          - maple.expectation.global.error.exception.marker.CircuitBreakerRecordMarker
    instances:
      nexonApi:
        baseConfig: default

  retry:
    retry-aspect-order: 399 # Retryê°€ CircuitBreakerë¥¼ ê°ì‹¸ë„ë¡ ì„¤ì •
    instances:
      nexonApi:
        maxAttempts: 3
        waitDuration: 500ms
        retryExceptions:
          - java.util.concurrent.TimeoutException
          - org.springframework.web.reactive.function.client.WebClientRequestException # ë„¤íŠ¸ì›Œí¬ ë‹¨ì ˆ ëŒ€ì‘
          - java.net.UnknownHostException

# ğŸ“ [PR #1] ë¡œê¹… ì„¤ì • (MDC í¬í•¨)
logging:
  level:
    root: info
    org.hibernate.SQL: info
    org.hibernate.orm.jdbc.batch: ERROR
  pattern:
    # [%X{requestId}]ê°€ í•µì‹¬ì…ë‹ˆë‹¤!
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} %5p [%X{requestId}] --- [%thread] %-40.40logger{39} : %m%n"

# ë„¥ìŠ¨ API í‚¤
nexon:
  api:
    key: ${NEXON_API_KEY}

server:
  shutdown: graceful

# ì•± ì „ìš© ì„¤ì •
app:
  optimization:
    use-compression: true
  aop:
    trace:
      enabled: true