spring:
  application:
    name: maple-expectation
  profiles:
    active: local # [Safety Guard] 별도 설정 없으면 무조건 로컬 모드
  lifecycle:
    timeout-per-shutdown-phase: 30s

  # 공통 드라이버 설정
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      register-mbeans: true # JMX를 통해 지표 노출 활성화

  # 공통 JPA 설정
  jpa:
    open-in-view: false
    properties:
      hibernate:
        jdbc:
          batch_size: 1000
        format_sql: false
        show_sql: false

management:
  endpoints:
    web:
      exposure:
        include: "health,info,metrics,prometheus,loggers"

  endpoint:
    health:
      show-details: always # 서킷 브레이커 상태를 상세히 보기 위해 필수
  health:
    circuitbreakers:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name} # 모든 메트릭에 앱 이름 태그 부여

resilience4j:
  circuitbreaker:
    circuit-breaker-aspect-order: 400
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowSize: 10              # 최근 10번의 호출 기준
        failureRateThreshold: 50           # 실패율 50% 이상 시 Open
        waitDurationInOpenState: 10s       # Open 유지 시간
        permittedNumberOfCallsInHalfOpenState: 3
        ignoreExceptions:
          # 비즈니스 예외(404 등)는 실패로 카운트하지 않음
          - maple.expectation.global.error.exception.marker.CircuitBreakerIgnoreMarker
        recordExceptions:
          - maple.expectation.global.error.exception.marker.CircuitBreakerRecordMarker
    instances:
      nexonApi:
        baseConfig: default

  retry:
    retry-aspect-order: 399 # Retry가 CircuitBreaker를 감싸도록 설정
    instances:
      nexonApi:
        maxAttempts: 3
        waitDuration: 500ms
        retryExceptions:
          - java.util.concurrent.TimeoutException
          - org.springframework.web.reactive.function.client.WebClientRequestException # 네트워크 단절 대응
          - java.net.UnknownHostException
      nexonLockRetry:
        maxAttempts: 5             # 최대 5번 시도 (락 경합이 심할 때를 대비해 조금 넉넉히)
        waitDuration: 200ms        # 0.2초 간격으로 다시 시도
        retryExceptions:           # 이 예외가 발생했을 때만 재시도함
          - maple.expectation.global.error.exception.DistributedLockException

logging:
  level:
    org.springframework.cache: INFO
    maple.expectation.aop.aspect: INFO
    root: info
    org.hibernate.SQL: info
    org.hibernate.orm.jdbc.batch: ERROR
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} %5p [%X{requestId}] --- [%thread] %-40.40logger{39} : %m%n"

# 넥슨 API 키
nexon:
  api:
    key: ${NEXON_API_KEY}

server:
  shutdown: graceful

app:
  optimization:
    use-compression: true
  aop:
    trace:
      enabled: true