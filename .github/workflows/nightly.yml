# =============================================================================
# MapleExpectation Nightly Full Test (ë‹¨ê³„ë³„ ì‹¤í–‰)
# =============================================================================
# ë§¤ì¼ ìì •(KST) ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (chaos, nightmare í¬í•¨)
# CI Gateì—ì„œëŠ” fastTestë§Œ ì‹¤í–‰í•˜ë¯€ë¡œ, ì „ì²´ í…ŒìŠ¤íŠ¸ëŠ” ì—¬ê¸°ì„œ ìˆ˜í–‰
#
# [ë‹¨ê³„ë³„ ì‹¤í–‰] (Issue #194)
# Step 1: Unit Tests (fastTest) - ë¹ ë¥¸ í”¼ë“œë°±
# Step 2: Integration Tests - DB/Redis ì—°ë™
# Step 3: Chaos Tests - ì¥ì•  ì£¼ì… í…ŒìŠ¤íŠ¸
# Step 4: Nightmare Tests - ê·¹í•œ ì‹œë‚˜ë¦¬ì˜¤
#
# [ìµœì í™”] services ì œê±° - Testcontainersê°€ ì»¨í…Œì´ë„ˆë¥¼ ì§ì ‘ ê´€ë¦¬
# =============================================================================

name: Nightly Full Test

on:
  schedule:
    # ë§¤ì¼ KST 00:00 (UTC 15:00)
    - cron: '0 15 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      skip_unit:
        description: 'Skip Unit Tests'
        type: boolean
        default: false
      skip_integration:
        description: 'Skip Integration Tests'
        type: boolean
        default: false
      skip_chaos:
        description: 'Skip Chaos Tests'
        type: boolean
        default: false
      skip_nightmare:
        description: 'Skip Nightmare Tests'
        type: boolean
        default: false

permissions:
  contents: read
  checks: write

env:
  JAVA_VERSION: '21'
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.jvmargs=-Xmx2g'

jobs:
  # ==========================================================================
  # STEP 1: Unit Tests (Fast Feedback)
  # ==========================================================================
  unit-tests:
    name: 'Step 1: Unit Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event.inputs.skip_unit != 'true' }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Grant Execute Permission
        run: chmod +x gradlew

      - name: Run Unit Tests
        run: |
          echo "ğŸ§ª Step 1: Running Unit Tests (fastTest)"
          ./gradlew clean test -PfastTest --no-daemon --stacktrace
        env:
          SPRING_PROFILES_ACTIVE: test
          DOCKER_HOST: unix:///var/run/docker.sock
          TESTCONTAINERS_RYUK_DISABLED: true
          CI: true

      - name: Upload Unit Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports
          path: |
            build/reports/tests/
            build/test-results/
          retention-days: 14

  # ==========================================================================
  # STEP 2: Integration Tests
  # ==========================================================================
  integration-tests:
    name: 'Step 2: Integration Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: unit-tests
    if: ${{ github.event.inputs.skip_integration != 'true' && (success() || github.event.inputs.skip_unit == 'true') }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant Execute Permission
        run: chmod +x gradlew

      - name: Run Integration Tests
        run: |
          echo "ğŸ”— Step 2: Running Integration Tests"
          ./gradlew test -PintegrationTest --no-daemon --stacktrace
        env:
          SPRING_PROFILES_ACTIVE: test
          DOCKER_HOST: unix:///var/run/docker.sock
          TESTCONTAINERS_RYUK_DISABLED: true
          CI: true

      - name: Upload Integration Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-reports
          path: |
            build/reports/tests/
            build/test-results/
          retention-days: 14

  # ==========================================================================
  # STEP 3: Chaos Tests
  # ==========================================================================
  chaos-tests:
    name: 'Step 3: Chaos Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: integration-tests
    if: ${{ github.event.inputs.skip_chaos != 'true' && (success() || github.event.inputs.skip_integration == 'true') }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant Execute Permission
        run: chmod +x gradlew

      - name: Run Chaos Tests
        run: |
          echo "ğŸ’¥ Step 3: Running Chaos Tests"
          ./gradlew test -PchaosTest --no-daemon --stacktrace
        env:
          SPRING_PROFILES_ACTIVE: test
          DOCKER_HOST: unix:///var/run/docker.sock
          TESTCONTAINERS_RYUK_DISABLED: true
          CI: true

      - name: Upload Chaos Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-test-reports
          path: |
            build/reports/tests/
            build/test-results/
          retention-days: 14

  # ==========================================================================
  # STEP 4: Nightmare Tests
  # ==========================================================================
  nightmare-tests:
    name: 'Step 4: Nightmare Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: chaos-tests
    if: ${{ github.event.inputs.skip_nightmare != 'true' && (success() || github.event.inputs.skip_chaos == 'true') }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant Execute Permission
        run: chmod +x gradlew

      - name: Run Nightmare Tests
        run: |
          echo "ğŸ˜± Step 4: Running Nightmare Tests"
          ./gradlew test -PnightmareTest --no-daemon --stacktrace
        env:
          SPRING_PROFILES_ACTIVE: test
          DOCKER_HOST: unix:///var/run/docker.sock
          TESTCONTAINERS_RYUK_DISABLED: true
          CI: true

      - name: Upload Nightmare Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightmare-test-reports
          path: |
            build/reports/tests/
            build/test-results/
          retention-days: 14

  # ==========================================================================
  # FINAL: Summary & Notification
  # ==========================================================================
  summary:
    name: 'Summary'
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, chaos-tests, nightmare-tests]
    if: always()

    steps:
      - name: Download All Reports
        uses: actions/download-artifact@v4
        with:
          path: all-reports
        continue-on-error: true

      - name: Test Summary
        run: |
          echo "ğŸ“Š Nightly Test Summary"
          echo "======================="
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Chaos Tests: ${{ needs.chaos-tests.result }}"
          echo "Nightmare Tests: ${{ needs.nightmare-tests.result }}"

      - name: Upload Combined Reports
        uses: actions/upload-artifact@v4
        with:
          name: nightly-combined-reports
          path: all-reports/
          retention-days: 14
        continue-on-error: true

      - name: Publish Test Results
        uses: dorny/test-reporter@v1
        with:
          name: Nightly Test Results
          path: 'all-reports/**/test/*.xml'
          reporter: java-junit
          fail-on-error: false
        continue-on-error: true
