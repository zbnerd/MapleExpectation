name: Java CI/CD with Gradle

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

# SRE: Cancel in-progress runs for same PR (save resources)
concurrency:
  group: gradle-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ==========================================
  # ğŸ”¨ JOB 1: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ (CI)
  # ==========================================
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Unit tests only - 10ë¶„ì´ë©´ ì¶©ë¶„

    # Redis ì„œë¹„ìŠ¤ ì¶”ê°€: í…ŒìŠ¤íŠ¸ì—ì„œ Redis ì‚¬ìš©
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21  # #262: Virtual Thread ì§€ì›
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.event_name == 'pull_request' }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # PR/Push: -PfastTest (slow, nightmare ì œì™¸ â†’ 3-5ë¶„)
      # Nightly: ì „ì²´ í…ŒìŠ¤íŠ¸ (ë³„ë„ ì›Œí¬í”Œë¡œìš°)
      - name: Test with Gradle
        run: |
          echo "ğŸš€ Running fast tests (CI Gate)"
          ./gradlew test -PfastTest --stacktrace

      - name: Build JAR
        run: ./gradlew clean :module-app:bootJar -x test

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: maple-app
          path: module-app/build/libs/*.jar
          retention-days: 1

  # ==========================================
  # ğŸš€ JOB 2: ì„œë²„ ë°°í¬ (CD)
  # ==========================================
  deploy:
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    timeout-minutes: 10  # SRE: Prevent zombie deploy jobs

    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: maple-app
          path: ./build-artifact

      # -----------------------------------------------------------
      # [ì¶”ê°€] 1. ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ (í¬íŠ¸ ì ìœ  í•´ì œ)
      # íŒŒì¼ì„ ë³µì‚¬í•˜ê¸° ì „ì— ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ì£½ì—¬ì•¼ "Text file busy"ë¥¼ í”¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      # -----------------------------------------------------------
      - name: Stop Existing Process
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "Stopping existing process on port 8080..."
            # 8080 í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ ì°¾ì•„ ì¢…ë£Œ (ì—†ì–´ë„ ì—ëŸ¬ë‚´ì§€ ì•ŠìŒ)
            sudo fuser -k -n tcp 8080 || true
            sleep 2

      # 2. íŒŒì¼ ì „ì†¡ (ì´ì œ íŒŒì¼ì´ ì‚¬ìš© ì¤‘ì´ ì•„ë‹ˆë¯€ë¡œ ì•ˆì „í•˜ê²Œ ë®ì–´ì”ë‹ˆë‹¤)
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./build-artifact/*.jar"
          target: "/home/${{ secrets.EC2_USERNAME }}"
          strip_components: 1

      # 3. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ìƒˆë¡œìš´ í”„ë¡œì„¸ìŠ¤ ì‹œì‘)
      - name: Execute Deploy Script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # í™˜ê²½ë³€ìˆ˜ ì£¼ì…
            export DB_USER="${{ secrets.DB_USER }}"
            export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            export NEXON_API_KEY="${{ secrets.NEXON_API_KEY }}"
            export DISCORD_WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"

            # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ë° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            chmod +x /home/${{ secrets.EC2_USERNAME }}/deploy.sh
            /home/${{ secrets.EC2_USERNAME }}/deploy.sh