// ========================================
// Module-App: Spring Boot 실행, Controller, Config
// ADR-017: Application Layer
// ========================================

plugins {
	id 'org.springframework.boot' version '3.5.4'
}

// Integration Test Source Set Configuration
sourceSets {
	integrationTest {
		java.srcDir file('src/integrationTest/java')
		resources.srcDir file('src/integrationTest/resources')
		compileClasspath += sourceSets.main.output + configurations.testRuntimeClasspath
		runtimeClasspath += output + compileClasspath
	}
}

configurations {
	integrationTestImplementation.extendsFrom testImplementation
	integrationTestRuntimeOnly.extendsFrom testRuntimeOnly
	integrationTestAnnotationProcessor.extendsFrom testAnnotationProcessor
}

// IntelliJ IDEA Integration
idea {
	module {
		testSourceDirs += sourceSets.integrationTest.java.srcDirs
		testResourceDirs += sourceSets.integrationTest.resources.srcDirs
	}
}

dependencies {
	// Lombok for integration tests
	integrationTestCompileOnly 'org.projectlombok:lombok:1.18.30'
	integrationTestAnnotationProcessor 'org.projectlombok:lombok:1.18.30'

	implementation project(':module-core')
	implementation project(':module-infra')
	implementation project(':module-common')

	// Spring Web
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation 'org.springframework.boot:spring-boot-starter-webflux'
	implementation 'org.springframework.boot:spring-boot-starter-validation'
	implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'

	// Spring Security
	implementation 'org.springframework.boot:spring-boot-starter-security'
	testImplementation 'org.springframework.security:spring-security-test'

	// JWT
	implementation 'io.jsonwebtoken:jjwt-api:0.12.6'
	runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.12.6'
	runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.12.6'

	// Actuator & Observability
	implementation 'org.springframework.boot:spring-boot-starter-actuator'
	implementation 'io.micrometer:micrometer-registry-prometheus'
	implementation 'io.micrometer:micrometer-tracing-bridge-otel'
	implementation 'io.opentelemetry:opentelemetry-exporter-otlp'
	implementation 'io.opentelemetry.contrib:opentelemetry-samplers:1.33.0-alpha'

	// SpringDoc OpenAPI
	implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.8.13'

	// Loki Appender
	implementation 'com.github.loki4j:loki-logback-appender:1.4.2'

	// AI SRE (LangChain4j)
	implementation 'dev.langchain4j:langchain4j-spring-boot-starter:0.29.0'
	implementation 'dev.langchain4j:langchain4j-open-ai-spring-boot-starter:0.29.0'

	// Spring Batch
	implementation 'org.springframework.boot:spring-boot-starter-batch'

	// Cache
	implementation 'org.springframework.boot:spring-boot-starter-cache'
	implementation 'com.github.ben-manes.caffeine:caffeine'

	// Spring Data JPA
	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
	runtimeOnly 'com.mysql:mysql-connector-j'
	runtimeOnly 'com.h2database:h2'

	// Redisson (Redis)
	implementation 'org.redisson:redisson-spring-boot-starter:3.48.0'

	// Resilience4j
	implementation 'io.github.resilience4j:resilience4j-spring-boot3'

	// Guava
	implementation 'com.google.guava:guava:33.5.0-jre'

	// Bucket4j
	implementation 'com.bucket4j:bucket4j_jdk17-core:8.14.0'
	implementation 'com.bucket4j:bucket4j_jdk17-redisson:8.14.0'

	// Jackson CSV
	implementation 'com.fasterxml.jackson.dataformat:jackson-dataformat-csv'

	// Env
	implementation 'me.paulschwarz:spring-dotenv:4.0.0'

	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testImplementation 'org.testcontainers:toxiproxy'
}

// Enable plain jar for inter-module dependencies (chaos-test module needs it)
// bootJar remains for execution
tasks.named("jar") {
	enabled = true
	archiveClassifier = "plain"  // Plain jar without dependencies (don't override bootJar)
}

bootRun {
	jvmArgs = [
		'-Xms512m',
		'-Xmx1024m',
		'-XX:+UseG1GC'
	]
}

// test-legacy는 빌드에서 제외
tasks.named('test') {
	exclude '**/test-legacy/**'
}

// Integration Test Task
tasks.register('integrationTest', Test) {
	description = 'Runs integration tests (Testcontainers, DB, Redis).'
	group = 'verification'

	testClassesDirs = sourceSets.integrationTest.output.classesDirs
	classpath = sourceSets.integrationTest.runtimeClasspath
	useJUnitPlatform()

	shouldRunAfter tasks.test

	// JUnit configuration for integration tests
	useJUnitPlatform {
		includeTags 'integration'
	}

	// JVM settings for integration tests
	jvmArgs = [
		'-Xms512m',
		'-Xmx2048m',
		'-XX:+UseG1GC',
		'-XX:MaxMetaspaceSize=512m'
	]

	// Docker socket for Testcontainers - environment variable AND system property
	environment "DOCKER_HOST", "unix:///var/run/docker.sock"
	systemProperty "DOCKER_HOST", "unix:///var/run/docker.sock"

	// Disable Ryuk container for simpler setup (optional, remove if needed)
	environment "TESTCONTAINERS_RYUK_DISABLED", "true"

	// Testcontainers reuse for faster tests
	systemProperty "testcontainers.reuse.enable", "true"

	// Test logging
	testLogging {
		events "passed", "skipped", "failed"
		exceptionFormat "full"
	}

	// Retry flaky tests
	retry {
		maxRetries = 1
		maxFailures = 5
		failOnPassedAfterRetry = false
	}
}

// Fix duplicate resources issue
tasks.withType(ProcessResources).configureEach {
	duplicatesStrategy = DuplicatesStrategy.INCLUDE
}

// Lombok annotation processor for integration tests
// Note: integrationTestAnnotationProcessor extends testAnnotationProcessor, so Lombok is included
tasks.named('compileIntegrationTestJava') {
	options.annotationProcessorPath = configurations.integrationTestAnnotationProcessor
}
